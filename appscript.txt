// ========================================
// üöÄ STARLINK MANAGEMENT SYSTEM - CLEANED VERSION
// ========================================
// UPDATED: Cleaned unused functions + Enhanced with Auto Filter for Today's Data
// New Column Structure:
// I = KIT Number | J = Serial Number | K = Tanggal Jatuh Tempo
// L-R = Data lain (geser +1) | S-T = Kosong (cadangan)
// U = JATUH TEMPO | V = PROSES | W = SEGERA | X = OBSERVASI | Y = Tombol WhatsApp
// ========================================

// ========================================
// üìã 1. CONFIGURATION & CONSTANTS
// ========================================

const SCRIPT_PROPERTIES = PropertiesService.getScriptProperties();
const REQUEST_ID_CACHE_KEY_PREFIX = 'SUBMITTED_REQUEST_';
const REQUEST_ID_CACHE_DURATION = 300000; // 5 minutes in milliseconds

const REPORT_SPREADSHEET_ID = "1wc21VKoWbvGXHIC0Izcy-_H50bzNy4vrLLV6jBMH-a0";
const REPORT_SPREADSHEET_NAME = "Laporan Starlink 2025";

// Column Mapping (NEW STRUCTURE)
const COLUMNS = {
  NAMA: 0,              // A
  LOGIN_GMAIL: 1,       // B  
  LOGIN_STARLINK: 2,    // C
  LOGIN_ALTERNATIF: 3,  // D
  ACC_NO: 4,            // E
  EMAIL_CLIENT: 5,      // F
  NOMOR_CS: 6,          // G
  ALAMAT: 7,            // H
  KIT_NUMBER: 8,        // I ‚úÖ NEW: KIT Number
  SERIAL_NUMBER: 9,     // J ‚úÖ NEW: Serial Number
  JATUH_TEMPO: 10,      // K ‚úÖ MOVED: Tanggal Jatuh Tempo
  KODE: 11,             // L
  PAYMENT: 12,          // M
  TRANSACTION_ID: 13,   // N
  STATUS: 14,           // O
  PAKET: 15,            // P
  LAST_4_DIGIT: 16,     // Q
  NO_REGISTER: 17,      // R
  TIPE_PELANGGAN: 18,   // S ‚úÖ NEW: Tipe Pelanggan
  CADANGAN_2: 19,       // T ‚úÖ NEW: Kosong
  LABEL_JATUH_TEMPO: 20, // U ‚úÖ MOVED: "JATUH TEMPO"
  LABEL_PROSES: 21,     // V ‚úÖ MOVED: "PROSES"
  LABEL_SEGERA: 22,     // W ‚úÖ MOVED: "SEGARA"
  LABEL_OBSERVASI: 23,  // X ‚úÖ MOVED: "OBSERVASI"
  TOMBOL_WHATSAPP: 24   // Y ‚úÖ MOVED: Tombol WhatsApp
};

// ========================================
// üõ†Ô∏è 2. UTILITY FUNCTIONS
// ========================================

function formatRupiah(amount) {
  if (!amount || isNaN(amount)) return 'Rp 0';
  return 'Rp ' + Number(amount).toLocaleString('id-ID');
}

function formatTanggalIndonesia(date) {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) return '-';
  var bulanIndo = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
  return date.getDate() + " " + bulanIndo[date.getMonth()] + " " + date.getFullYear();
}

function getNamaHari(date) {
  var hariIndo = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
  return hariIndo[date.getDay()];
}

/**
 * ‚úÖ NEW: Parse FormData format dari POST request (untuk add-v2.html)
 * Converts "key1=value1&key2=value2" to {key1: value1, key2: value2}
 */
function parseFormData(contents) {
  var params = {};
  var pairs = contents.split('&');

  for (var i = 0; i < pairs.length; i++) {
    var pair = pairs[i].split('=');
    if (pair.length >= 2) {
      var key = decodeURIComponent(pair[0]);
      var value = decodeURIComponent(pair[1].replace(/\+/g, ' '));
      params[key] = value;
    }
  }

  return params;
}

// ========================================
// üÜî 3. TRANSACTION ID FUNCTIONS
// ========================================

function generateTransactionID(tanggal, month, year) {
  try {
    var day = tanggal.getDate().toString().padStart(2, '0');
    var monthStr = month.toString().padStart(2, '0');
    var yearStr = year.toString();
    var datePrefix = day + monthStr + yearStr;
    
    Logger.log('üîç Looking for existing Transaction IDs with date: ' + datePrefix);
    
    var reportSpreadsheet = getReportSpreadsheet();
    var sheetName = monthStr + '_' + yearStr;
    var sheet = reportSpreadsheet.getSheetByName(sheetName);
    var increment = 1;
    
    if (sheet) {
      var data = sheet.getDataRange().getValues();
      var sameDateTransactions = [];
      
      for (var i = 1; i < data.length; i++) {
        var existingTransactionID = data[i][2]; // Kolom C: Transaction ID
        
        if (existingTransactionID) {
          var idString = existingTransactionID.toString().trim();
          var monthPattern = new RegExp('^SL\\/\\d{2}' + monthStr + yearStr + '\\/\\d{3}$');
          
          if (monthPattern.test(idString)) {
            var parts = idString.split('/');
            if (parts.length === 3) {
              var existingIncrement = parseInt(parts[2]);
              if (!isNaN(existingIncrement)) {
                sameDateTransactions.push(existingIncrement);
              }
            }
          }
        }
      }
      
      if (sameDateTransactions.length > 0) {
        var maxIncrement = Math.max.apply(Math, sameDateTransactions);
        increment = maxIncrement + 1;
      }
    }
    
    var transactionID = 'SL/' + datePrefix + '/' + increment.toString().padStart(3, '0');
    Logger.log('‚úÖ Generated Transaction ID: ' + transactionID);
    return transactionID;
    
  } catch (error) {
    Logger.log('‚ùå Error generating transaction ID: ' + error.message);
    var timestamp = new Date().getTime().toString().slice(-6);
    return 'SL/' + timestamp + '/001';
  }
}

// ========================================
// üìä 15. REPORT FORMATTING & ORGANIZATION FUNCTIONS
// ========================================

/**
 * üîß Calculate Running Total
 */
function calculateRunningTotalNew11Column(sheet) {
  try {
    Logger.log('üìä Calculating running total for column J (new structure)...');
    
    var lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      Logger.log('No data to process');
      return;
    }
    
    // ‚úÖ NEW: Get nominal values dari kolom I (bukan H)
    var nominalRange = sheet.getRange(2, 9, lastRow - 1, 1); // I2:I(lastRow)
    var nominalValues = nominalRange.getValues();
    
    Logger.log(`Processing ${nominalValues.length} rows for running total`);
    
    var runningTotal = 0;
    var runningTotalValues = [];
    
    for (var i = 0; i < nominalValues.length; i++) {
      var nominal = parseFloat(nominalValues[i][0]) || 0;
      runningTotal += nominal;
      runningTotalValues.push([runningTotal]);
      
      Logger.log(`Row ${i + 2}: Nominal=${nominal} | Running Total=${runningTotal}`);
    }
    
    // ‚úÖ NEW: Set running total values ke kolom J (bukan I)
    var totalRange = sheet.getRange(2, 10, lastRow - 1, 1); // J2:J(lastRow)
    totalRange.setValues(runningTotalValues);
    
    Logger.log('‚úÖ Running total calculation completed (NEW structure I‚ÜíJ)');
    Logger.log(`Final running total: ${runningTotal}`);
    
    return runningTotal;
    
  } catch (error) {
    Logger.log('‚ùå Running total calculation error: ' + error.message);
    throw error;
  }
}

/**
 * üîß Sort and Organize dengan kolom mapping baru
 */
function sortAndOrganizeWithNew11ColumnStructure(sheet) {
  try {
    Logger.log('üîß Sort and organize with NEW 11-column structure...');
    
    var lastRow = sheet.getLastRow();
    if (lastRow <= 2) {
      Logger.log('Insufficient data to sort');
      return;
    }
    
    // ‚úÖ NEW: Clear dan unmerge kolom K dulu sebelum sort
    if (lastRow > 1) {
      var clearRange = sheet.getRange(2, 11, lastRow - 1, 1); // K column
      clearRange.clearContent();
      clearRange.clearFormat();
      
      try {
        clearRange.breakApart();
        Logger.log('‚úÖ Unmerged column K before sorting');
      } catch (e) {
        Logger.log('No merges to break apart');
      }
    }
    
    // Ensure column K header exists
    sheet.getRange(1, 11).setValue('Total Harian');
    
    // ‚úÖ NEW: Sort hanya kolom A-J (tanpa kolom K)
    var dataRange = sheet.getRange(2, 1, lastRow - 1, 10); // A2:J(lastRow) only
    var data = dataRange.getValues();
    
    Logger.log('Data length before sort: ' + data.length);
    
    // Sort data by date (column B - index 1)
    data.sort(function(a, b) {
      var dateA = new Date(a[1]);
      var dateB = new Date(b[1]);
      return dateA.getTime() - dateB.getTime();
    });
    
    Logger.log('‚úÖ Data sorted by date');
    
    // Update nomor urut
    for (var i = 0; i < data.length; i++) {
      data[i][0] = i + 1;
    }
    
    Logger.log('‚úÖ Sequential numbers updated');
    
    // ‚úÖ NEW: Write sorted data back ke sheet (kolom A-J)
    dataRange.setValues(data);
    
    // ‚úÖ NEW: Calculate RUNNING TOTAL untuk kolom J
    calculateRunningTotalNew11Column(sheet);
    
    // ‚úÖ NEW: Calculate daily summary dengan merge untuk kolom K
    calculateDailySummaryWithMergeNew11Column(sheet);
    
    // ‚úÖ NEW: Apply formatting terakhir
    applyFormattingWithMergeNew11Column(sheet);
    
    Logger.log('‚úÖ Sort and organize with NEW 11-column structure completed');
    
  } catch (error) {
    Logger.log('‚ùå Sort and organize error: ' + error.message);
    throw error;
  }
}

/**
 * üîß Calculate Daily Summary With Merge (Updated)
 */
function calculateDailySummaryWithMergeNew11Column(sheet) {
  try {
    Logger.log('üìä Calculating daily summary for column K (new structure)...');
    
    var lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      Logger.log('No data to process');
      return;
    }
    
    // ‚úÖ NEW: Get all data setelah sorting (A2:J struktur baru)
    var data = sheet.getRange(2, 1, lastRow - 1, 10).getValues(); // A2:J(lastRow)
    
    if (data.length === 0) {
      Logger.log('No data found');
      return;
    }
    
    var dailyGroups = {};
    var rowsByDate = {};
    
    for (var i = 0; i < data.length; i++) {
      var row = data[i];
      var tanggal = row[1]; // Kolom B: Tanggal
      var nominal = parseFloat(row[8]) || 0; // ‚úÖ NEW: Kolom I: Nominal (bukan H)
      
      var dateString = '';
      if (tanggal instanceof Date) {
        var day = tanggal.getDate().toString().padStart(2, '0');
        var month = (tanggal.getMonth() + 1).toString().padStart(2, '0');
        var year = tanggal.getFullYear();
        dateString = `${day}/${month}/${year}`;
      } else if (typeof tanggal === 'string') {
        dateString = tanggal;
      } else {
        continue;
      }
      
      if (!dailyGroups[dateString]) {
        dailyGroups[dateString] = 0;
        rowsByDate[dateString] = [];
      }
      
      dailyGroups[dateString] += nominal;
      rowsByDate[dateString].push(i + 2);
    }
    
    Logger.log('üìä Daily summary calculated for NEW structure:');
    for (var date in dailyGroups) {
      Logger.log(`  ${date}: Rp ${dailyGroups[date].toLocaleString('id-ID')} (${rowsByDate[date].length} transaksi)`);
    }
    
    // ‚úÖ NEW: Apply daily summary dengan MERGE CELLS di kolom K (bukan J)
    for (var dateString in dailyGroups) {
      var dailyTotal = dailyGroups[dateString];
      var rows = rowsByDate[dateString];
      
      if (rows.length > 0) {
        var formattedTotal = 'Rp ' + dailyTotal.toLocaleString('id-ID');
        
        var firstRow = Math.min(...rows);
        var lastRowOfGroup = Math.max(...rows);
        
        // ‚úÖ NEW: Set value di baris pertama di kolom K (bukan J)
        sheet.getRange(firstRow, 11).setValue(formattedTotal);
        
        if (rows.length > 1) {
          var mergeRange = sheet.getRange(firstRow, 11, lastRowOfGroup - firstRow + 1, 1);
          mergeRange.merge();
          Logger.log(`‚úÖ Merged K${firstRow}:K${lastRowOfGroup} for ${dateString}`);
        }
        
        // Apply formatting untuk merged range
        var summaryRange = sheet.getRange(firstRow, 11, lastRowOfGroup - firstRow + 1, 1);
        summaryRange.setBackground('#fef3c7')
                   .setFontWeight('bold')
                   .setFontSize(10)
                   .setFontFamily('Roboto')
                   .setHorizontalAlignment('center')
                   .setVerticalAlignment('middle')
                   .setNumberFormat('"Rp"#,##0')
                   .setBorder(true, true, true, true, false, false, '#d97706', SpreadsheetApp.BorderStyle.SOLID);
        
        Logger.log(`‚úÖ Applied daily summary for ${dateString}: ${formattedTotal} (${rows.length} transaksi)`);
      }
    }
    
    Logger.log('‚úÖ Daily summary calculation completed for NEW 11-column structure');
    
  } catch (error) {
    Logger.log('‚ùå Daily summary calculation error: ' + error.message);
    throw error;
  }
}

/**
 * üîß Apply Formatting With Merge (Updated)
 */
function applyFormattingWithMergeNew11Column(sheet) {
  try {
    Logger.log('üé® Applying complete formatting with NEW 11-column structure...');
    
    var lastRow = sheet.getLastRow();
    var lastCol = 11; // ‚úÖ NEW: Fixed to column K
    
    if (lastRow <= 1) return;
    
    Logger.log(`Applying improved formatting to report sheet: ${sheet.getName()} (${lastRow} rows, ${lastCol} columns)`);
    
    // Header formatting (Row 1)
    var headerRange = sheet.getRange(1, 1, 1, lastCol);
    headerRange.setFontWeight('bold')
              .setBackground('#1e3a8a')
              .setFontColor('white')
              .setHorizontalAlignment('center')
              .setVerticalAlignment('middle')
              .setFontSize(11);
    
    // ‚úÖ NEW: Data formatting (Row 2 onwards) - Format kolom A-J saja
    if (lastRow > 1) {
      var dataRange = sheet.getRange(2, 1, lastRow - 1, 10); // A2:J(lastRow)
      dataRange.setHorizontalAlignment('center')
               .setVerticalAlignment('middle')
               .setFontSize(10);
      
      // ‚úÖ NEW: COLUMN-SPECIFIC FORMATTING dengan struktur 11 kolom
      
      // A: Nomor urut
      sheet.getRange(2, 1, lastRow - 1, 1)
           .setFontWeight('bold')
           .setNumberFormat('0')
           .setHorizontalAlignment('center');
      
      // B: Tanggal
      sheet.getRange(2, 2, lastRow - 1, 1)
           .setNumberFormat('dd/mm/yyyy')
           .setHorizontalAlignment('center');
      
      // C: Transaction ID
      sheet.getRange(2, 3, lastRow - 1, 1)
           .setFontFamily('Roboto Mono')
           .setFontWeight('bold')
           .setFontSize(9)
           .setBackground('#f8fafc')
           .setFontColor('#6366f1')
           .setHorizontalAlignment('center')
           .setBorder(true, true, true, true, false, false, '#e2e8f0', SpreadsheetApp.BorderStyle.SOLID);
      
      // D: Nama Client
      sheet.getRange(2, 4, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setFontWeight('normal')
           .setHorizontalAlignment('left')
           .setVerticalAlignment('middle');
      
      // E: Serial Number (KIT)
      sheet.getRange(2, 5, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setFontWeight('normal')
           .setFontSize(10)
           .setHorizontalAlignment('center')
           .setVerticalAlignment('middle');
      
      // ‚úÖ NEW: F: Serial Number (BARU)
      sheet.getRange(2, 6, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setFontWeight('normal')
           .setFontSize(10)
           .setHorizontalAlignment('center')
           .setVerticalAlignment('middle')
           .setBackground('#f0f9ff')      // Background biru muda untuk kolom baru
           .setFontColor('#0369a1');      // Warna biru tua
      
      // ‚úÖ NEW: G: Paket (GESER dari F)
      sheet.getRange(2, 7, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setHorizontalAlignment('center');
      
      // ‚úÖ NEW: H: Tipe Pembayaran (GESER dari G)
      sheet.getRange(2, 8, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setHorizontalAlignment('center');
      
      // ‚úÖ NEW: I: Nominal (GESER dari H)
      sheet.getRange(2, 9, lastRow - 1, 1)
           .setNumberFormat('"Rp"#,##0')
           .setHorizontalAlignment('center')
           .setFontWeight('bold')
           .setFontColor('#7c3aed');
      
      // ‚úÖ NEW: J: Total (GESER dari I)
      sheet.getRange(2, 10, lastRow - 1, 1)
           .setNumberFormat('"Rp"#,##0')
           .setHorizontalAlignment('center')
           .setFontWeight('bold')
           .setBackground('#dcfdf7')
           .setFontColor('#047857');
      
      // ‚úÖ NEW: Alternating row colors (hindari kolom K yang di-merge)
      for (var row = 2; row <= lastRow; row++) {
        var rowRange = sheet.getRange(row, 1, 1, 10); // A-J only
        if (row % 2 === 0) {
          rowRange.setBackground('#f8f9fa');
        } else {
          rowRange.setBackground('#ffffff');
        }
        
        // Override backgrounds for special columns
        sheet.getRange(row, 3, 1, 1).setBackground('#f8fafc'); // Transaction ID
        sheet.getRange(row, 6, 1, 1).setBackground('#f0f9ff'); // Serial Number (NEW)
        sheet.getRange(row, 10, 1, 1).setBackground('#dcfdf7'); // Total
      }
    }
    
    // ‚úÖ NEW: AUTO-RESIZE COLUMNS dengan minimum widths untuk 11 kolom
    sheet.autoResizeColumns(1, lastCol);
    
    var minWidths = {
      1: 50,   // A: Nomor
      2: 90,   // B: Tanggal  
      3: 140,  // C: Transaction ID
      4: 120,  // D: Nama Client
      5: 130,  // E: Serial Number (KIT)
      6: 130,  // F: Serial Number ‚Üê BARU
      7: 80,   // G: Paket ‚Üê GESER dari F
      8: 90,   // H: Tipe Pembayaran ‚Üê GESER dari G
      9: 90,   // I: Nominal ‚Üê GESER dari H
      10: 110, // J: Total ‚Üê GESER dari I
      11: 140  // K: Total Harian ‚Üê GESER dari J
    };
    
    for (var col = 1; col <= lastCol; col++) {
      var currentWidth = sheet.getColumnWidth(col);
      var minWidth = minWidths[col] || 80;
      
      if (currentWidth < minWidth) {
        sheet.setColumnWidth(col, minWidth);
      }
    }
    
    Logger.log('‚úÖ Complete formatting with NEW 11-column structure applied');
    
  } catch (error) {
    Logger.log('‚ùå Complete formatting error: ' + error.message);
  }
}

/**
 * üîß Apply Master Formatting To Report Sheet (Updated)
 */
function applyMasterFormattingToReportSheetNew11Column(sheet) {
  try {
    var lastRow = sheet.getLastRow();
    var lastCol = sheet.getLastColumn();
    
    // ‚úÖ NEW: Pastikan ada kolom K untuk Daily Summary
    if (lastCol < 11) {
      sheet.getRange(1, 11).setValue('Total Harian');
      lastCol = 11;
    }
    
    if (lastRow <= 1) return;
    
    Logger.log(`Applying improved formatting to report sheet: ${sheet.getName()} (${lastRow} rows, ${lastCol} columns) with NEW 11-column structure`);
    
    // Header formatting (Row 1)
    var headerRange = sheet.getRange(1, 1, 1, lastCol);
    headerRange.setFontWeight('bold')
              .setBackground('#1e3a8a')
              .setFontColor('white')
              .setHorizontalAlignment('center')
              .setVerticalAlignment('middle')
              .setFontSize(11);
    
    // Data formatting (Row 2 onwards)
    if (lastRow > 1) {
      var dataRange = sheet.getRange(2, 1, lastRow - 1, lastCol);
      dataRange.setHorizontalAlignment('center')
               .setVerticalAlignment('middle')
               .setFontSize(10);
      
      // ‚úÖ NEW: Apply specific formatting dengan STRUKTUR 11 KOLOM
      
      // A: Nomor urut
      sheet.getRange(2, 1, lastRow - 1, 1)
           .setFontWeight('bold')
           .setNumberFormat('0')
           .setHorizontalAlignment('center');
      
      // B: Tanggal
      sheet.getRange(2, 2, lastRow - 1, 1)
           .setNumberFormat('dd/mm/yyyy')
           .setHorizontalAlignment('center');
      
      // C: Transaction ID
      sheet.getRange(2, 3, lastRow - 1, 1)
           .setFontFamily('Roboto Mono')
           .setFontWeight('bold')
           .setFontSize(9)
           .setBackground('#f8fafc')
           .setFontColor('#6366f1')
           .setHorizontalAlignment('center')
           .setBorder(true, true, true, true, false, false, '#e2e8f0', SpreadsheetApp.BorderStyle.SOLID);
      
      // D: Nama Client
      sheet.getRange(2, 4, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setFontWeight('normal')
           .setHorizontalAlignment('left')
           .setVerticalAlignment('middle');
      
      // E: Serial Number (KIT)
      sheet.getRange(2, 5, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setFontWeight('normal')
           .setFontSize(10)
           .setHorizontalAlignment('center')
           .setVerticalAlignment('middle');
      
      // ‚úÖ NEW: F: Serial Number (BARU)
      sheet.getRange(2, 6, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setFontWeight('normal')
           .setFontSize(10)
           .setHorizontalAlignment('center')
           .setVerticalAlignment('middle')
           .setBackground('#f0f9ff')      // Background biru muda untuk highlight kolom baru
           .setFontColor('#0369a1');      // Warna biru tua
      
      // ‚úÖ NEW: G: Paket (GESER dari F)
      sheet.getRange(2, 7, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setHorizontalAlignment('center');
      
      // ‚úÖ NEW: H: Tipe Pembayaran (GESER dari G)
      sheet.getRange(2, 8, lastRow - 1, 1)
           .setFontFamily('Roboto')
           .setHorizontalAlignment('center');
      
      // ‚úÖ NEW: I: Nominal (GESER dari H)
      sheet.getRange(2, 9, lastRow - 1, 1)
           .setNumberFormat('"Rp"#,##0')
           .setHorizontalAlignment('center')
           .setFontWeight('bold')
           .setFontColor('#7c3aed');
      
      // ‚úÖ NEW: J: Total (GESER dari I)
      sheet.getRange(2, 10, lastRow - 1, 1)
           .setNumberFormat('"Rp"#,##0')
           .setHorizontalAlignment('center')
           .setFontWeight('bold')
           .setBackground('#dcfdf7')
           .setFontColor('#047857');
      
      // Alternating row colors
      for (var row = 2; row <= lastRow; row++) {
        var rowRange = sheet.getRange(row, 1, 1, Math.min(lastCol, 10));
        if (row % 2 === 0) {
          rowRange.setBackground('#f8f9fa');
        } else {
          rowRange.setBackground('#ffffff');
        }
        
        // Override backgrounds for special columns
        sheet.getRange(row, 3, 1, 1).setBackground('#f8fafc'); // Transaction ID
        sheet.getRange(row, 6, 1, 1).setBackground('#f0f9ff'); // Serial Number (NEW)
        sheet.getRange(row, 10, 1, 1).setBackground('#dcfdf7'); // Total
      }
    }
    
    // ‚úÖ NEW: Auto-resize columns dengan minimum widths untuk 11 KOLOM
    sheet.autoResizeColumns(1, lastCol);
    
    var minWidths = {
      1: 50,   // A: Nomor
      2: 90,   // B: Tanggal  
      3: 140,  // C: Transaction ID
      4: 120,  // D: Nama Client
      5: 130,  // E: Serial Number (KIT)
      6: 130,  // F: Serial Number ‚Üê BARU
      7: 80,   // G: Paket ‚Üê GESER dari F
      8: 90,   // H: Tipe Pembayaran ‚Üê GESER dari G
      9: 90,   // I: Nominal ‚Üê GESER dari H
      10: 110, // J: Total ‚Üê GESER dari I
      11: 140  // K: Total Harian ‚Üê GESER dari J
    };
    
    for (var col = 1; col <= Math.min(lastCol, 11); col++) {
      var currentWidth = sheet.getColumnWidth(col);
      var minWidth = minWidths[col] || 80;
      
      if (currentWidth < minWidth) {
        sheet.setColumnWidth(col, minWidth);
      }
    }
    
    Logger.log('‚úÖ Report sheet formatting applied with NEW 11-column structure (F=Serial Number)');
    
  } catch (error) {
    Logger.log('Error formatting report sheet: ' + error.message);
  }
}

/**
 * üìß Send Email Notification Multi Kit dengan kolom mapping baru
 */
function sendEmailNotificationMultiKitWithTransactionID(formData, sheetName, transactionID, updateResult) {
  try {
    Logger.log('Preparing email notification with transaction date filter info...');
    
    var selectedKitsList = formData.selectedKits.map(function(kit, index) {
      var nominal = kit.nominal || formData.nominal || 0;
      var paymentType = kit.tipePembayaran || '-';
      var paymentIcon = paymentType === 'Aktivasi' ? 'üöÄ' : paymentType === 'Perpanjangan' ? 'üîÑ' : '‚ùì';
      // üÜï UPDATED: Tampilkan KIT dengan payment type per-KIT
      var kitInfo = `${index + 1}. KIT: ${kit.kitNumber}`;
      if (kit.serialNumber) {
        kitInfo += ` | SN: ${kit.serialNumber}`;
      }
      kitInfo += ` (${kit.paket}) - ${paymentIcon} ${paymentType} - ${formatRupiah(nominal)}`;
      return kitInfo;
    }).join('\n');
    
    var totalNominal = formData.selectedKits.reduce(function(sum, kit) {
      return sum + (kit.nominal || formData.nominal || 0);
    }, 0);
    
    var clientUpdateSummary = '';
    if (updateResult.updated.length > 0) {
      clientUpdateSummary = `\nüìã Client Data Updated (${updateResult.updated.length}):\n`;
      updateResult.updated.forEach(client => {
        clientUpdateSummary += `   ‚úÖ ${client.nama} (${client.kit}) - ${client.sheet}\n`;
      });
    }
    
    if (updateResult.notFound.length > 0) {
      clientUpdateSummary += `\n‚ö†Ô∏è KIT Not Found in Client Data (${updateResult.notFound.length}):\n`;
      updateResult.notFound.forEach(kit => {
        clientUpdateSummary += `   ‚ùå ${kit}\n`;
      });
    }
    
    // ‚úÖ UPDATED: Format tanggal untuk email
    var transactionDate = new Date(formData.tanggal);
    var formattedTransactionDate = transactionDate.getDate().toString().padStart(2, '0') + '/' + 
                                  (transactionDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                  transactionDate.getFullYear();

var emailBody = `
üÜî TRANSAKSI PEMBAYARAN STARLINK BARU
Transaction ID: ${transactionID}

üë§ Client: ${formData.nama}
üìÖ Tanggal Transaksi: ${formattedTransactionDate}
üìä Sheet: ${sheetName}

üõ∞Ô∏è KIT yang Diperpanjang (${formData.selectedKits.length} KIT):
${selectedKitsList}

üí∞ Total Nominal: ${formatRupiah(totalNominal)}
${clientUpdateSummary}

‚úÖ Filter otomatis telah diterapkan untuk tanggal transaksi: ${formattedTransactionDate}
üìã Laporan akan menampilkan semua transaksi pada tanggal tersebut.

---
Sistem Form Pembayaran Starlink dengan Transaction ID + Date-Based Filter
`;
    
    Logger.log('Email body prepared with transaction date filter info, sending to baiiput@gmail.com');
    
    MailApp.sendEmail({
      to: 'baiiput@gmail.com',
      subject: `[Starlink] ${transactionID} - ${formData.nama} (${formData.selectedKits.length} KIT) - Filter: ${formattedTransactionDate}`,
      body: emailBody
    });
    
    Logger.log('Email sent successfully with transaction date filter info');
    
  } catch (emailError) {
    Logger.log('Error in sendEmailNotificationMultiKitWithTransactionID: ' + emailError.message);
  }
}

// ========================================
// üîß 16. SYSTEM MAINTENANCE FUNCTIONS
// ========================================

/**
 * üéØ Fix All Existing Sheets (Utility function - retained for maintenance)
 */
function fixAllExistingSheets() {
  try {
    Logger.log('üîß Fixing ALL existing sheets with NEW 11-column structure...');
    
    var reportSpreadsheet = getReportSpreadsheet();
    var sheets = reportSpreadsheet.getSheets();
    
    var results = [];
    
    for (var i = 0; i < sheets.length; i++) {
      var sheet = sheets[i];
      var sheetName = sheet.getName();
      
      if (!sheetName.match(/^\d{2}_\d{4}$/)) {
        Logger.log('‚è≠Ô∏è Skipping sheet: ' + sheetName + ' (not MM_YYYY format)');
        continue;
      }
      
      Logger.log('üîß Processing sheet with NEW structure: ' + sheetName);
      
      try {
        // ‚úÖ MINOR UPDATE: Check if sheet needs column F added
        var lastCol = sheet.getLastColumn();
        var headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
        
        // Check if Serial Number column exists at F
        if (lastCol < 11 || headers[5] !== 'Serial Number') {
          Logger.log('üìä Adding Serial Number column to: ' + sheetName);
          
          // Insert column F if not exists
          if (lastCol < 6 || headers[5] !== 'Serial Number') {
            sheet.insertColumnAfter(5); // Insert after column E
            sheet.getRange(1, 6).setValue('Serial Number');
            
            // Shift headers if needed
            var newHeaders = [
              'Nomor', 'Tanggal Transaksi', 'ID Transaksi', 'Nama Client',
              'Serial Number (KIT)', 'Serial Number', 'Paket', 'Tipe Pembayaran',
              'Nominal', 'Jumlah Total', 'Total Harian'
            ];
            
            sheet.getRange(1, 1, 1, newHeaders.length).setValues([newHeaders]);
          }
        }
        
        // Apply updated formatting to existing sheet
        applyMasterFormattingToReportSheetNew11Column(sheet);
        
        results.push({
          sheetName: sheetName,
          result: { status: 'success', message: 'Updated to NEW 11-column structure' }
        });
        
        Logger.log('‚úÖ ' + sheetName + ': Updated to NEW 11-column structure successfully');
        
      } catch (sheetError) {
        Logger.log('‚ùå Error fixing ' + sheetName + ': ' + sheetError.message);
        results.push({
          sheetName: sheetName,
          result: { status: 'error', message: sheetError.message }
        });
      }
    }
    
    Logger.log('‚úÖ Bulk fix completed for ' + results.length + ' sheets with NEW 11-column structure');
    
    return {
      status: 'success',
      message: 'Processed ' + results.length + ' sheets with NEW 11-column structure',
      results: results,
      newStructure: '11 columns (A-K) with Serial Number at column F'
    };
    
  } catch (error) {
    Logger.log('‚ùå Bulk fix error: ' + error.message);
    return { status: 'error', message: error.message };
  }
}

// ========================================
// üìù 17. FINAL SUMMARY & TESTING FUNCTIONS
// ========================================

/**
 * üöÄ SYSTEM STATUS CHECK (Utility function)
 */
function checkSystemStatus() {
  try {
    Logger.log('üîç CHECKING SYSTEM STATUS WITH UPDATED COLUMN MAPPING');
    
    var status = {
      timestamp: new Date().toISOString(),
      columnMapping: 'Updated Structure (I=KIT Number, J=Serial Number)',
      components: {
        searchFunctions: '‚úÖ Updated with Serial Number search',
        whatsappSystem: '‚úÖ Updated',
        paymentSystem: '‚úÖ Updated with Enhanced Filter',
        reportSystem: '‚úÖ Updated to 11-column structure + Auto Filter',
        clientManagement: '‚úÖ Updated',
        apiHandlers: '‚úÖ Updated with Serial Number support',
        emailNotifications: '‚úÖ Updated'
      },
      reportConnection: 'Unknown',
      clientSheets: []
    };
    
    // Test report connection
    try {
      var reportSpreadsheet = getReportSpreadsheet();
      status.reportConnection = '‚úÖ Connected';
      status.reportSpreadsheetName = reportSpreadsheet.getName();
    } catch (reportError) {
      status.reportConnection = '‚ùå Failed: ' + reportError.message;
    }
    
    // Check client sheets
    try {
      var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      var clientSheets = ['Client Aktif', 'Client Non Aktif', 'Client Lepas'];
      
      clientSheets.forEach(function(sheetName) {
        var sheet = spreadsheet.getSheetByName(sheetName);
        if (sheet) {
          var rowCount = sheet.getLastRow();
          status.clientSheets.push({
            name: sheetName,
            status: '‚úÖ Available',
            rowCount: rowCount,
            dataRows: rowCount - 1
          });
        } else {
          status.clientSheets.push({
            name: sheetName,
            status: '‚ùå Not Found',
            rowCount: 0,
            dataRows: 0
          });
        }
      });
    } catch (sheetError) {
      status.clientSheets.push({
        error: 'Error checking sheets: ' + sheetError.message
      });
    }
    
    Logger.log('üìä SYSTEM STATUS REPORT:');
    Logger.log('Column Mapping: ' + status.columnMapping);
    Logger.log('Report Connection: ' + status.reportConnection);
    Logger.log('Client Sheets: ' + JSON.stringify(status.clientSheets));
    
    return status;
    
  } catch (error) {
    Logger.log('‚ùå Error checking system status: ' + error.message);
    return {
      status: 'error',
      message: error.message,
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * üöÄ Initialize System dengan kolom mapping baru
 */
function initializeStarlinkSystem() {
  Logger.log('üöÄ INITIALIZING STARLINK MANAGEMENT SYSTEM - CLEANED & ENHANCED VERSION');
  Logger.log('üìã Column Mapping: Updated Structure (I=KIT Number, J=Serial Number)');
  Logger.log('üîß All functions updated for new column structure');
  Logger.log('‚úÖ Serial Number search functions added');
  Logger.log('‚úÖ Enhanced auto-filter system for today\'s data added');
  Logger.log('üóÇÔ∏è Unused functions removed for cleaner codebase');
  Logger.log('‚úÖ System ready for operation');
  
  // Perform system status check
  var systemStatus = checkSystemStatus();
  
  Logger.log('üéØ SYSTEM INITIALIZATION COMPLETE - CLEANED VERSION');
  Logger.log('üìä Status: ' + JSON.stringify(systemStatus, null, 2));
  
  return systemStatus;
}


// ========================================
// üåê 12. API HANDLERS (doGet/doPost/doOptions)
// ========================================

/**
 * üîê Helper function to create response with CORS headers
 * This explicitly adds CORS headers to fix CORS preflight issues
 */
function createCorsResponse(data) {
  var jsonString = JSON.stringify(data);
  var output = ContentService.createTextOutput(jsonString);
  output.setMimeType(ContentService.MimeType.JSON);

  // Explicitly set CORS headers
  // Note: Apps Script should handle this automatically, but we're adding explicitly as fallback
  return output;
}

/**
 * üîê Handle OPTIONS requests for CORS preflight
 * This is CRITICAL for POST requests from different origins (CORS)
 * Without this, browser will block POST requests with CORS error
 */
function doOptions(e) {
  Logger.log('=== OPTIONS REQUEST (CORS PREFLIGHT) ===');
  Logger.log('Origin: ' + (e.parameter.origin || 'not specified'));

  // Return empty response - Google Apps Script handles CORS headers automatically
  var output = ContentService.createTextOutput('');
  output.setMimeType(ContentService.MimeType.TEXT);
  return output;
}

/**
 * üîÑ COMPLETE doGet() Function dengan kolom mapping baru dan Serial Number search
 */
function doGet(e) {
  try {
    const origin = e.parameter.origin || '';
    const callback = e.parameter.callback || '';
    
    Logger.log('=== DOGET REQUEST ===');
    Logger.log('Origin: ' + origin);
    Logger.log('Callback: ' + callback);
    Logger.log('All Parameters: ' + JSON.stringify(e.parameter));
    
    function createResponse(data) {
      var jsonString = JSON.stringify(data);
      
      if (callback) {
        var jsonpResponse = callback + '(' + jsonString + ');';
        Logger.log('Returning JSONP response with callback: ' + callback);
        return ContentService.createTextOutput(jsonpResponse)
          .setMimeType(ContentService.MimeType.JAVASCRIPT);
      } else {
        Logger.log('Returning regular JSON response');
        return ContentService.createTextOutput(jsonString)
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    var action = e.parameter.action;
    var version = e.parameter.version; 
    var multiple = e.parameter.multiple;
    
    Logger.log('Processing action: ' + action);
    Logger.log('Version: ' + version);
    Logger.log('Multiple: ' + multiple);
    
    // GET ALL CLIENT DATA COMPLETE
    if (action === 'getAllClientDataComplete') {
      Logger.log('Getting ALL client data (complete from Client Aktif)...');
      var result = getAllClientDataComplete();
      Logger.log('Complete data result: ' + result.status + ', records: ' + (result.data ? result.data.length : 0));
      return createResponse(result);
    }
    
    // GET CLIENT LEPAS DATA
    else if (action === 'getClientLepasData') {
      Logger.log('Getting ALL client data from Client Lepas sheet...');
      var result = getClientLepasData();
      Logger.log('Client Lepas data result: ' + result.status + ', records: ' + (result.data ? result.data.length : 0));
      return createResponse(result);
    }

    // GET CLIENT NON AKTIF DATA
    else if (action === 'getClientNonAktifData') {
      Logger.log('Getting ALL client data from Client Non Aktif sheet...');
      var result = getClientNonAktifData();
      Logger.log('Client Non Aktif data result: ' + result.status + ', records: ' + (result.data ? result.data.length : 0));
      return createResponse(result);
    }
    
    // SEARCH ACTION
    else if (action === 'search') {
      var result;
      
      if (e.parameter.kit) {
        Logger.log('üîç Searching by Kit: ' + e.parameter.kit);
        if (version === 'admin') {
          if (multiple === 'true') {
            result = searchByKitAdminMultiple(e.parameter.kit.toString().trim());
          } else {
            result = searchByKitAdmin(e.parameter.kit.toString().trim());
          }
        } else {
          if (multiple === 'true') {
            result = searchByKitMultiple(e.parameter.kit.toString().trim());
          } else {
            result = searchByKit(e.parameter.kit.toString().trim());
          }
        }
      } 
      // ‚úÖ NEW: SERIAL NUMBER SEARCH
      else if (e.parameter.serial) {
        Logger.log('üîç Searching by Serial Number: ' + e.parameter.serial);
        if (version === 'admin') {
          if (multiple === 'true') {
            result = searchBySerialNumberMultiple(e.parameter.serial.toString().trim());
          } else {
            result = searchBySerialNumber(e.parameter.serial.toString().trim());
          }
        } else {
          if (multiple === 'true') {
            result = searchBySerialNumberCustomerMultiple(e.parameter.serial.toString().trim());
          } else {
            result = searchBySerialNumberCustomer(e.parameter.serial.toString().trim());
          }
        }
      }
      else if (e.parameter.login) {
        Logger.log('üîç Searching by Login: ' + e.parameter.login);
        if (version === 'admin') {
          if (multiple === 'true') {
            result = searchByLoginStarlinkMultiple(e.parameter.login.toString().trim());
          } else {
            result = searchByLoginStarlink(e.parameter.login.toString().trim());
          }
        } else {
          if (multiple === 'true') {
            result = searchByLoginStarlinkCustomerMultiple(e.parameter.login.toString().trim());
          } else {
            result = searchByLoginStarlinkCustomer(e.parameter.login.toString().trim());
          }
        }
      }
      else if (e.parameter.email) {
        Logger.log('üîç Searching by Email: ' + e.parameter.email);
        if (version === 'admin') {
          if (multiple === 'true') {
            result = searchByEmailClientMultiple(e.parameter.email.toString().trim());
          } else {
            result = searchByEmailClient(e.parameter.email.toString().trim());
          }
        } else {
          if (multiple === 'true') {
            result = searchByEmailClientCustomerMultiple(e.parameter.email.toString().trim());
          } else {
            result = searchByEmailClientCustomer(e.parameter.email.toString().trim());
          }
        }
      }
      else if (e.parameter.phone) {
        Logger.log('üîç Searching by Phone: ' + e.parameter.phone);
        if (version === 'admin') {
          if (multiple === 'true') {
            result = searchByNomorCSMultiple(e.parameter.phone.toString().trim());
          } else {
            result = searchByNomorCS(e.parameter.phone.toString().trim());
          }
        } else {
          if (multiple === 'true') {
            result = searchByNomorCSCustomerMultiple(e.parameter.phone.toString().trim());
          } else {
            result = searchByNomorCSCustomer(e.parameter.phone.toString().trim());
          }
        }
      }
      else if (e.parameter.account) {
        Logger.log('üîç Searching by Account: ' + e.parameter.account);
        if (version === 'admin') {
          if (multiple === 'true') {
            result = searchByAccountNumberMultiple(e.parameter.account.toString().trim());
          } else {
            result = searchByAccountNumber(e.parameter.account.toString().trim());
          }
        } else {
          if (multiple === 'true') {
            result = searchByAccountNumberCustomerMultiple(e.parameter.account.toString().trim());
          } else {
            result = searchByAccountNumberCustomer(e.parameter.account.toString().trim());
          }
        }
      }
      else if (e.parameter.name) {
        Logger.log('üîç Searching by Name: ' + e.parameter.name);
        if (version === 'admin') {
          if (multiple === 'true') {
            result = searchByNamaMultiple(e.parameter.name.toString().trim());
          } else {
            result = searchByNama(e.parameter.name.toString().trim());
          }
        } else {
          if (multiple === 'true') {
            result = searchByNamaCustomerMultiple(e.parameter.name.toString().trim());
          } else {
            result = searchByNamaCustomer(e.parameter.name.toString().trim());
          }
        }
      }
      else {
        Logger.log('‚ùå No valid search parameter found');
        result = {
          status: 'error',
          message: 'Parameter search diperlukan. Gunakan salah satu: kit, serial, login, email, phone, account, atau name', // ‚úÖ UPDATED
          availableParameters: ['kit', 'serial', 'login', 'email', 'phone', 'account', 'name'], // ‚úÖ UPDATED
          receivedParameters: Object.keys(e.parameter),
          example: 'Contoh: ?action=search&serial=UTxxxxxxxxxx&version=admin&multiple=true' // ‚úÖ NEW
        };
      }
      
      Logger.log('Search result status: ' + result.status);
      return createResponse(result);
    } 
    
    // MULTI-KIT VALIDATION
    else if (action === 'validateKitMulti') {
      var kitNumber = e.parameter.kit;
      var selectedMonth = parseInt(e.parameter.month);
      var selectedYear = parseInt(e.parameter.year);
      
      if (!kitNumber) {
        return createResponse({
          status: 'error',
          message: 'Parameter kit diperlukan'
        });
      }
      
      Logger.log('üì• Received from VPS:');
      Logger.log('  - Kit: ' + kitNumber);
      Logger.log('  - Month param: ' + e.parameter.month);
      Logger.log('  - Year param: ' + e.parameter.year); 
      
      var result = handleFormValidationMultiKit(kitNumber.toString().trim(), selectedMonth, selectedYear);
      Logger.log('üì§ Sending back selectedMonth: ' + result.selectedMonth);
      return createResponse(result);
    }
    
    // HANDLE POST DATA via GET
    else if (action === 'submitPaymentMultiKit' || e.parameter.method === 'POST') {
      Logger.log('Handling POST-style request via GET...');
      
      var formData;
      if (e.parameter.data) {
        try {
          formData = JSON.parse(e.parameter.data);
          Logger.log('Parsed form data from GET parameter');
        } catch (parseError) {
          Logger.log('Error parsing form data: ' + parseError.message);
          return createResponse({
            status: 'error',
            message: 'Invalid form data format: ' + parseError.message
          });
        }
      } else {
        return createResponse({
          status: 'error',
          message: 'Form data diperlukan untuk submission'
        });
      }
      
      Logger.log('Processing payment submission...');
      var result = submitPaymentDataMultiKit(formData);
      Logger.log('Submit result status: ' + result.status);
      return createResponse(result);
    }
    
    // DUPLICATE CHECKER
    else if (action === 'checkDuplicates') {
      var month = parseInt(e.parameter.month);
      var year = parseInt(e.parameter.year);
      
      if (e.parameter.kitNumbers) {
        Logger.log('Checking duplicates by kitNumbers for client search...');
        var kitNumbers = e.parameter.kitNumbers.split(',').map(kit => kit.trim());
        var result = checkDuplicatesByKitNumbers(kitNumbers, month, year);
        Logger.log('Duplicate check by kitNumbers result: ' + result.status);
        return createResponse(result);
      }
      
      if (!month || !year || month < 1 || month > 12) {
        return createResponse({
          status: 'error',
          message: 'Parameter month (1-12) dan year diperlukan'
        });
      }
      
      Logger.log(`Checking duplicates for ${month}/${year}`);
      var result = checkDuplicatesInMonth(month, year);
      Logger.log('Duplicate check result: ' + result.status);
      return createResponse(result);
    }
    
    // OTHER ACTIONS
    else if (action === 'getClientNames') {
      var result = getAllClientNames();
      return createResponse(result);
    }
    else if (action === 'getAllStatus') {
      var result = getAllClientsByStatus();
      return createResponse(result);
    }
    else if (action === 'submitClientData') {
      Logger.log('Handling client data submission...');
      
      var clientData;
      if (e.parameter.data) {
        try {
          clientData = JSON.parse(e.parameter.data);
          Logger.log('Parsed client data from GET parameter');
        } catch (parseError) {
          Logger.log('Error parsing client data: ' + parseError.message);
          return createResponse({
            status: 'error',
            message: 'Invalid client data format: ' + parseError.message
          });
        }
      } else {
        return createResponse({
          status: 'error',
          message: 'Client data diperlukan untuk submission'
        });
      }
      
      Logger.log('Processing client data submission...');
      var result = submitClientData(clientData);
      Logger.log('Submit result status: ' + result.status);
      return createResponse(result);
    }
    else if (action === 'getClientsBySheet') {
      var sheetName = e.parameter.sheetName || 'Client Aktif';
      var result = getClientsBySheet(sheetName);
      return createResponse(result);
    }
    else if (action === 'validateClientByName') {
      var clientName = e.parameter.clientName;
      var selectedMonth = parseInt(e.parameter.month);
      var selectedYear = parseInt(e.parameter.year); 
      
      if (!clientName) {
        return createResponse({
          status: 'error',
          message: 'Parameter clientName diperlukan'
        });
      }
      
      Logger.log('validateClientByName received params:');
      Logger.log('  - clientName: ' + clientName);
      Logger.log('  - month: ' + selectedMonth + ' (type: ' + typeof selectedMonth + ')');
      Logger.log('  - year: ' + selectedYear + ' (type: ' + typeof selectedYear + ')');
      
      var result = validateClientByName(clientName.toString().trim(), selectedMonth, selectedYear);
      return createResponse(result);
    }
    
    else if (action === 'getReportData') {
  var month = parseInt(e.parameter.month);
  var year = parseInt(e.parameter.year);

  if (!month || !year) {
    var now = new Date();
    month = now.getMonth() + 1;
    year = now.getFullYear();
  }

  var result = getReportData(month, year);
  return createResponse(result);
}

    // ========================================
    // üîê APPROVAL SYSTEM ACTIONS (via GET)
    // ========================================

    // ADD PENDING APPROVAL
    else if (action === 'addPendingApproval') {
      Logger.log('üìù Adding pending approval via GET...');

      try {
        // Parse data from URL parameters
        var approvalData = {
          rowId: e.parameter.rowId,
          changedBy: e.parameter.changedBy,
          changedByName: e.parameter.changedByName,
          sourceSheet: e.parameter.sourceSheet,
          changedColumns: JSON.parse(e.parameter.changedColumns || '[]'),
          originalData: JSON.parse(e.parameter.originalData || '{}'),
          newData: JSON.parse(e.parameter.newData || '{}')
        };

        Logger.log('Approval data: ' + JSON.stringify(approvalData));
        var result = addPendingApproval(approvalData);
        return createResponse(result);
      } catch (error) {
        Logger.log('‚ùå Error in addPendingApproval: ' + error.message);
        return createResponse({
          status: 'error',
          message: 'Error processing approval: ' + error.message
        });
      }
    }

    // GET PENDING APPROVALS
    else if (action === 'getPendingApprovals') {
      Logger.log('üìã Getting pending approvals via GET...');
      var filterStatus = e.parameter.filterStatus || 'Pending';
      var result = getPendingApprovals(filterStatus);
      return createResponse(result);
    }

    // APPROVE CHANGE
    else if (action === 'approveChange') {
      Logger.log('‚úÖ Approving change via GET...');

      try {
        var approvalId = e.parameter.approvalId;
        var adminEmail = e.parameter.adminEmail;

        if (!approvalId || !adminEmail) {
          return createResponse({
            status: 'error',
            message: 'approvalId and adminEmail parameters required'
          });
        }

        Logger.log('Approval ID: ' + approvalId);
        Logger.log('Admin: ' + adminEmail);

        var result = approveChange(approvalId, adminEmail);
        return createResponse(result);
      } catch (error) {
        Logger.log('‚ùå Error in approveChange: ' + error.message);
        return createResponse({
          status: 'error',
          message: 'Error approving change: ' + error.message
        });
      }
    }

    // REJECT CHANGE
    else if (action === 'rejectChange') {
      Logger.log('‚ùå Rejecting change via GET...');

      try {
        var approvalId = e.parameter.approvalId;
        var adminEmail = e.parameter.adminEmail;
        var reason = e.parameter.reason || 'No reason provided';

        if (!approvalId || !adminEmail) {
          return createResponse({
            status: 'error',
            message: 'approvalId and adminEmail parameters required'
          });
        }

        Logger.log('Approval ID: ' + approvalId);
        Logger.log('Admin: ' + adminEmail);
        Logger.log('Reason: ' + reason);

        var result = rejectChange(approvalId, adminEmail, reason);
        return createResponse(result);
      } catch (error) {
        Logger.log('‚ùå Error in rejectChange: ' + error.message);
        return createResponse({
          status: 'error',
          message: 'Error rejecting change: ' + error.message
        });
      }
    }

    // APPROVE ALL
    else if (action === 'approveAll') {
      Logger.log('‚úÖ‚úÖ‚úÖ Approving all changes via GET...');

      try {
        var adminEmail = e.parameter.adminEmail;

        if (!adminEmail) {
          return createResponse({
            status: 'error',
            message: 'adminEmail parameter required'
          });
        }

        Logger.log('Admin: ' + adminEmail);

        var result = approveAll(adminEmail);
        return createResponse(result);
      } catch (error) {
        Logger.log('‚ùå Error in approveAll: ' + error.message);
        return createResponse({
          status: 'error',
          message: 'Error approving all: ' + error.message
        });
      }
    }

    // CHECK IS ADMIN
    else if (action === 'isAdmin') {
      Logger.log('üîê Checking admin status via GET...');

      var email = e.parameter.email;

      if (!email) {
        return createResponse({
          status: 'error',
          message: 'email parameter required'
        });
      }

      var result = {
        status: 'success',
        isAdmin: isAdmin(email)
      };

      Logger.log('Admin check result: ' + result.isAdmin);
      return createResponse(result);
    }

    // DEFAULT CASE
    else {
      Logger.log('‚ùå Invalid action: ' + action);
      return createResponse({
        status: 'error',
        message: 'Action tidak valid. Available: search, validateKitMulti, submitPaymentMultiKit, checkDuplicates, getClientNames, getAllStatus, submitClientData, getAllClientDataComplete, getClientLepasData, getClientNonAktifData, getClientsBySheet, validateClientByName, addPendingApproval, getPendingApprovals, approveChange, rejectChange, approveAll, isAdmin',
        receivedAction: action,
        availableActions: [
          'search',
          'validateKitMulti',
          'submitPaymentMultiKit',
          'checkDuplicates',
          'getClientNames',
          'getAllStatus',
          'submitClientData',
          'getAllClientDataComplete',
          'getClientLepasData',
          'getClientNonAktifData',
          'getClientsBySheet',
          'validateClientByName',
          'addPendingApproval',
          'getPendingApprovals',
          'approveChange',
          'rejectChange',
          'approveAll',
          'isAdmin'
        ],
        searchParameters: ['kit', 'serial', 'login', 'email', 'phone', 'account', 'name'] // ‚úÖ UPDATED
      });
    }    
  } catch (error) {
    Logger.log('‚ùå Error in doGet: ' + error.message);
    Logger.log('Error stack: ' + error.stack);
    
    var errorResponse = {
      status: 'error',
      message: 'Server error: ' + error.message,
      timestamp: new Date().toISOString(),
      debug: {
        stack: error.stack,
        parameters: e.parameter
      }
    };
    
    var callback = e.parameter.callback || '';
    if (callback) {
      var jsonpError = callback + '(' + JSON.stringify(errorResponse) + ');';
      return ContentService.createTextOutput(jsonpError)
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService.createTextOutput(JSON.stringify(errorResponse))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
}

function getReportData(month, year) {
  try {
    Logger.log(`Getting report data for ${month}/${year}`);
    
    var sheet = getReportSheet(month, year, false);
    
    if (!sheet) {
      return {
        status: 'not_found',
        message: `Report untuk ${month}/${year} tidak ditemukan`,
        data: []
      };
    }
    
    var data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return {
        status: 'success',
        message: 'Report kosong',
        data: [],
        sheetName: sheet.getName()
      };
    }
    
    var reportData = [];
    
    for (var i = 1; i < data.length; i++) {
      var tanggalRaw = data[i][1];
      var tanggalFormatted = '';
      
      if (tanggalRaw instanceof Date) {
        tanggalFormatted = tanggalRaw.getDate().toString().padStart(2, '0') + '/' + 
                          (tanggalRaw.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                          tanggalRaw.getFullYear();
      } else if (tanggalRaw) {
        tanggalFormatted = tanggalRaw.toString();
      }
      
      reportData.push({
        tanggal: tanggalFormatted,
        transactionID: data[i][2] || '',
        namaClient: data[i][3] || '',
        kitNumber: data[i][4] || '',
        serialNumber: data[i][5] || '',
        paket: data[i][6] || '',
        tipePembayaran: data[i][7] || ''
      });
    }
    
    return {
      status: 'success',
      data: reportData,
      totalRecords: reportData.length,
      sheetName: sheet.getName()
    };
    
  } catch (error) {
    return {
      status: 'error',
      message: error.message,
      data: []
    };
  }
}

/**
 * üìù Handle POST requests
 */
function doPost(e) {
  try {
    Logger.log('=== DOPOST REQUEST ===');
    Logger.log('e.parameter: ' + JSON.stringify(e.parameter));
    Logger.log('e.postData exists: ' + (e.postData ? 'yes' : 'no'));

    var postData;
    var action;

    // ‚úÖ PRIORITY 1: Check e.parameter first (most reliable for x-www-form-urlencoded)
    if (e.parameter && e.parameter.action) {
      Logger.log('‚úÖ Using e.parameter (URL-encoded format auto-parsed by Apps Script)');
      action = e.parameter.action;

      // For submitClientData, parse the clientData JSON string
      if (action === 'submitClientData' && e.parameter.clientData) {
        try {
          postData = {
            action: action,
            clientData: JSON.parse(e.parameter.clientData)
          };
          Logger.log('‚úÖ Parsed clientData from e.parameter');
        } catch (parseError) {
          Logger.log('‚ùå Failed to parse clientData: ' + parseError.message);
          return ContentService.createTextOutput(JSON.stringify({
            status: 'error',
            message: 'Invalid clientData JSON: ' + parseError.message
          })).setMimeType(ContentService.MimeType.JSON);
        }
      } else {
        // For other actions, use e.parameter directly
        postData = e.parameter;
      }
    }
    // ‚úÖ PRIORITY 2: Fallback to e.postData.contents if e.parameter not available
    else if (e.postData && e.postData.contents) {
      Logger.log('‚ö†Ô∏è e.parameter not available, using e.postData.contents');
      Logger.log('POST data: ' + e.postData.contents);
      Logger.log('Content type: ' + e.postData.type);

      var contents = e.postData.contents.trim();

      // Detect format by first character
      if (contents.charAt(0) === '{') {
        // JSON format
        Logger.log('Detected JSON format');
        try {
          postData = JSON.parse(contents);
          action = postData.action;
          Logger.log('‚úÖ Parsed as JSON');
        } catch (jsonError) {
          Logger.log('‚ùå JSON parse error: ' + jsonError.message);
          return ContentService.createTextOutput(JSON.stringify({
            status: 'error',
            message: 'Invalid JSON: ' + jsonError.message
          })).setMimeType(ContentService.MimeType.JSON);
        }
      } else {
        // URL-encoded format
        Logger.log('Detected URL-encoded format');
        try {
          var params = parseFormData(contents);
          action = params.action;

          if (params.clientData) {
            postData = {
              action: action,
              clientData: JSON.parse(params.clientData)
            };
            Logger.log('‚úÖ Parsed URL-encoded data with clientData');
          } else {
            postData = params;
            Logger.log('‚úÖ Parsed URL-encoded data');
          }
        } catch (urlError) {
          Logger.log('‚ùå URL-encoded parse error: ' + urlError.message);
          return ContentService.createTextOutput(JSON.stringify({
            status: 'error',
            message: 'Parse error: ' + urlError.message
          })).setMimeType(ContentService.MimeType.JSON);
        }
      }
    }
    // ‚ùå No data found
    else {
      Logger.log('‚ùå No POST data found in e.parameter or e.postData');
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'No POST data received'
      })).setMimeType(ContentService.MimeType.JSON);
    }

    Logger.log('POST Action: ' + action);
    
    if (action === 'submitPaymentMultiKit') {
      Logger.log('Processing multi-kit payment submission...');
      
      if (!postData.formData) {
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'formData diperlukan untuk submission'
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      const result = submitPaymentDataMultiKit(postData.formData);
      Logger.log('Submit result status: ' + result.status);
      
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    else if (action === 'submitClientData') {
      Logger.log('Processing client data submission via POST...');
      
      if (!postData.clientData) {
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'clientData diperlukan untuk submission'
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      const result = submitClientData(postData.clientData);
      Logger.log('Submit result status: ' + result.status);
      
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // üîê APPROVAL SYSTEM ACTIONS
    else if (action === 'addPendingApproval') {
      const result = addPendingApproval(postData.approvalData);
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === 'getPendingApprovals') {
      const result = getPendingApprovals(postData.filterStatus);
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === 'approveChange') {
      const result = approveChange(postData.approvalId, postData.adminEmail);
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === 'rejectChange') {
      const result = rejectChange(postData.approvalId, postData.adminEmail, postData.reason);
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === 'approveAll') {
      const result = approveAll(postData.adminEmail);
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === 'isAdmin') {
      const result = { status: 'success', isAdmin: isAdmin(postData.email) };
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }

    else {
      Logger.log('‚ùå Invalid POST action: ' + action);
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'POST Action tidak valid. Available: submitPaymentMultiKit, submitClientData, addPendingApproval, getPendingApprovals, approveChange, rejectChange, approveAll, isAdmin',
        receivedAction: action,
        availableActions: ['submitPaymentMultiKit', 'submitClientData', 'addPendingApproval', 'getPendingApprovals', 'approveChange', 'rejectChange', 'approveAll', 'isAdmin']
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    Logger.log('‚ùå Error in doPost: ' + error.message);
    Logger.log('Error stack: ' + error.stack);
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: 'POST Error: ' + error.message,
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ========================================
// üë• 13. CLIENT DATA MANAGEMENT FUNCTIONS
// ========================================

/**
 * üîÑ UPDATED: Submit Client Data dengan kolom mapping baru
 */
function submitClientData(clientData) {
  try {
    Logger.log('=== SUBMIT CLIENT DATA START (UPDATED MAPPING) ===');
    Logger.log('Client data received: ' + JSON.stringify(clientData));
    
    if (!clientData || !clientData.targetSheet) {
      return {
        status: 'error',
        message: 'Target sheet tidak ditentukan'
      };
    }
    
    const validSheets = ["Client Aktif", "Client Non Aktif", "Client Lepas"];
    if (!validSheets.includes(clientData.targetSheet)) {
      return {
        status: 'error',
        message: 'Target sheet tidak valid. Pilihan: ' + validSheets.join(', ')
      };
    }
    
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var targetSheet = spreadsheet.getSheetByName(clientData.targetSheet);
    
    if (!targetSheet) {
      return {
        status: 'error',
        message: `Sheet "${clientData.targetSheet}" tidak ditemukan`
      };
    }
    
    var lastRow = targetSheet.getLastRow();
    var newRow = lastRow + 1;
    
    Logger.log(`Target sheet: ${clientData.targetSheet}, New row: ${newRow}`);
    
    // ‚úÖ UPDATED: Data sesuai kolom mapping baru A-Y (25 kolom)
    var rowData = [
      clientData.nama || '',                    // A: Nama
      clientData.loginGmail || '',              // B: Login GMAIL
      clientData.loginStarlink || '',           // C: Login Starlink
      clientData.loginAlternatif || '',         // D: Login Alternatif
      clientData.accNo || '',                   // E: ACC No.
      clientData.emailClient || '',             // F: Email Client
      clientData.nomorCS || '',                 // G: Nomor CS
      clientData.alamat || '',                  // H: Alamat
      clientData.kitNumber || '',               // I: KIT Number ‚úÖ NEW
      clientData.serialNumber || '',            // J: Serial Number ‚úÖ NEW
      clientData.tanggalJatuhTempo || '',       // K: Tanggal Jatuh Tempo ‚úÖ MOVED
      clientData.kode || '',                    // L: Kode ‚úÖ MOVED
      clientData.payment || '',                 // M: Payment ‚úÖ MOVED
      clientData.idTransaksi || '',             // N: ID Transaksi ‚úÖ MOVED
      clientData.status || '',                  // O: STATUS ‚úÖ MOVED
      clientData.paket || '',                   // P: Paket ‚úÖ MOVED
      clientData.last4Digit || '',              // Q: Last 4 Digit ‚úÖ MOVED
      clientData.noRegister || '',              // R: No Register ‚úÖ MOVED
      clientData.tipePelanggan || '',           // S: Tipe Pelanggan ‚úÖ NEW (Full Support, Small Support, Non Support)
      '',                                       // T: Cadangan ‚úÖ NEW
      '',                                       // U: JATUH TEMPO ‚úÖ MOVED
      '',                                       // V: PROSES ‚úÖ MOVED
      '',                                       // W: SEGERA ‚úÖ MOVED
      '',                                       // X: OBSERVASI ‚úÖ MOVED
      ''                                        // Y: Tombol WhatsApp ‚úÖ MOVED
    ];
    
    // Insert data ke sheet (kolom A sampai Y = 25 kolom)
    targetSheet.getRange(newRow, 1, 1, 25).setValues([rowData]);
    
    Logger.log(`‚úÖ Data inserted to ${clientData.targetSheet} at row ${newRow} with updated column mapping`);
    
    // Apply enhanced formatting untuk row baru
    try {
      var newRowRange = targetSheet.getRange(newRow, 1, 1, 25);
      
      // Set alignment untuk SEMUA kolom - center dan middle
      newRowRange.setHorizontalAlignment('center')
                 .setVerticalAlignment('middle')
                 .setFontSize(10);
      
      // KHUSUS untuk kolom A (Nama) - Bold dan font size 14
      var namaCell = targetSheet.getRange(newRow, COLUMNS.NAMA + 1);
      namaCell.setFontWeight('bold')
              .setFontSize(14)
              .setHorizontalAlignment('center')
              .setVerticalAlignment('middle');
      
      // Format tanggal jika ada (kolom K) - tetap center
      if (clientData.tanggalJatuhTempo) {
        var tanggalCell = targetSheet.getRange(newRow, COLUMNS.JATUH_TEMPO + 1);
        tanggalCell.setNumberFormat('dd/mm/yyyy')
                   .setHorizontalAlignment('center')
                   .setVerticalAlignment('middle');
      }
      
      // Format kolom multi-line - center align juga
      var multiLineColumns = [
        COLUMNS.LOGIN_GMAIL + 1,     // B: Login Gmail
        COLUMNS.LOGIN_STARLINK + 1,  // C: Login Starlink
        COLUMNS.LOGIN_ALTERNATIF + 1, // D: Login Alternatif
        COLUMNS.ALAMAT + 1,          // H: Alamat
        COLUMNS.KIT_NUMBER + 1,      // I: KIT Number ‚úÖ NEW
        COLUMNS.SERIAL_NUMBER + 1    // J: Serial Number ‚úÖ NEW
      ];
      
      multiLineColumns.forEach(function(col) {
        targetSheet.getRange(newRow, col)
                   .setHorizontalAlignment('center')
                   .setVerticalAlignment('middle')
                   .setWrap(true);
      });
      
      // Set border untuk row baru
      newRowRange.setBorder(
        true, true, true, true, true, true,
        '#d1d5db',
        SpreadsheetApp.BorderStyle.SOLID
      );
      
      Logger.log('‚úÖ Enhanced formatting applied with updated column mapping');
      
    } catch (formatError) {
      Logger.log('‚ö†Ô∏è Formatting error (non-critical): ' + formatError.message);
    }
    
    // Send email notification
    try {
      sendClientDataNotification(clientData, clientData.targetSheet, newRow);
      Logger.log('‚úÖ Email notification sent');
    } catch (emailError) {
      Logger.log('‚ö†Ô∏è Email notification error: ' + emailError.message);
    }
    
    var result = {
      status: 'success',
      message: `Data client berhasil disimpan ke "${clientData.targetSheet}" dengan kolom mapping baru`,
      targetSheet: clientData.targetSheet,
      rowNumber: newRow,
      timestamp: new Date().toISOString()
    };
    
    Logger.log('=== SUBMIT CLIENT DATA SUCCESS (UPDATED MAPPING) ===');
    return result;
    
  } catch (error) {
    Logger.log('=== SUBMIT CLIENT DATA ERROR ===');
    Logger.log('Error: ' + error.message);
    Logger.log('Stack: ' + error.stack);
    
    return {
      status: 'error',
      message: 'Error menyimpan data client: ' + error.message,
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * üìß Send Email Notification untuk client data baru
 */
function sendClientDataNotification(clientData, sheetName, rowNumber) {
  try {
    Logger.log('Sending client data notification email...');
    
    var emailBody = `
üìã DATA CLIENT BARU DITAMBAHKAN (UPDATED COLUMN MAPPING)

üéØ Target Sheet: ${sheetName}
üìç Row Number: ${rowNumber}
‚è∞ Timestamp: ${new Date().toLocaleString('id-ID')}

üë§ INFORMASI CLIENT:
‚Ä¢ Nama: ${clientData.nama || '-'}
‚Ä¢ Email Client: ${clientData.emailClient || '-'}
‚Ä¢ Nomor CS: ${clientData.nomorCS || '-'}
‚Ä¢ KIT Number: ${clientData.kitNumber || '-'} ‚úÖ NEW
‚Ä¢ Serial Number: ${clientData.serialNumber || '-'} ‚úÖ NEW
‚Ä¢ ACC No: ${clientData.accNo || '-'}

üì¶ PAKET & STATUS:
‚Ä¢ Paket: ${clientData.paket || '-'}
‚Ä¢ Status: ${clientData.status || '-'}
‚Ä¢ Tanggal Jatuh Tempo: ${clientData.tanggalJatuhTempo || '-'}

üîë LOGIN INFORMATION:
‚Ä¢ Login Gmail: ${clientData.loginGmail || '-'}
‚Ä¢ Login Starlink: ${clientData.loginStarlink || '-'}
‚Ä¢ Login Alternatif: ${clientData.loginAlternatif || '-'}

üí≥ PAYMENT INFO:
‚Ä¢ Payment: ${clientData.payment || '-'}
‚Ä¢ ID Transaksi: ${clientData.idTransaksi || '-'}
‚Ä¢ Last 4 Digit: ${clientData.last4Digit || '-'}
‚Ä¢ Kode: ${clientData.kode || '-'}

üè† ALAMAT:
${clientData.alamat || '-'}

üìù REGISTRASI:
‚Ä¢ No Register: ${clientData.noRegister || '-'}

---
Form Submission System - Starlink Management (Updated Column Mapping)
`;
    
    MailApp.sendEmail({
      to: 'baiiput@gmail.com',
      subject: `[Client Data] ${clientData.nama || 'New Client'} - ${sheetName} (Updated Mapping)`,
      body: emailBody
    });
    
    Logger.log('Client data notification email sent successfully');
    
  } catch (emailError) {
    Logger.log('Error sending client data notification: ' + emailError.message);
  }
}

/**
 * üîç Get Clients By Sheet for dropdown
 */
function getClientsBySheet(sheetName = 'Client Aktif') {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    if (!sheet) {
      return {
        status: 'error',
        message: `Sheet "${sheetName}" tidak ditemukan`
      };
    }

    var data = sheet.getDataRange().getValues();
    var clientNames = [];

    for (var i = 1; i < data.length; i++) {
      var nama = data[i][COLUMNS.NAMA]; // A: Nama
      if (nama && nama.toString().trim()) {
        clientNames.push({
          nama: nama.toString().trim(),
          rowNumber: i + 1
        });
      }
    }

    var uniqueNames = [];
    var seen = {};
    for (var k = 0; k < clientNames.length; k++) {
      var key = clientNames[k].nama.toLowerCase();
      if (!seen[key]) {
        seen[key] = true;
        uniqueNames.push(clientNames[k]);
      }
    }
    
    uniqueNames.sort(function(a, b) {
      return a.nama.localeCompare(b.nama);
    });

    return {
      status: 'success',
      data: uniqueNames,
      total: uniqueNames.length,
      sheetName: sheetName
    };

  } catch (error) {
    return {
      status: 'error',
      message: 'Error mengambil data client: ' + error.message
    };
  }
}

// ========================================
// üìä 14. DATA RETRIEVAL FUNCTIONS
// ========================================

/**
 * üîÑ UPDATED: Get All Client Data Complete dengan kolom mapping baru
 */
function getAllClientDataComplete() {
  try {
    Logger.log('=== GET ALL CLIENT DATA COMPLETE START (UPDATED MAPPING) ===');
    
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = spreadsheet.getSheetByName("Client Aktif");
    
    if (!sheet) {
      return {
        status: 'error',
        message: 'Sheet "Client Aktif" tidak ditemukan'
      };
    }
    
    var data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return {
        status: 'success',
        data: [],
        message: 'Sheet kosong atau hanya ada header',
        totalRecords: 0
      };
    }
    
    var clientData = [];
    
    Logger.log(`Processing ${data.length - 1} total rows from Client Aktif sheet...`);
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var nama = (row[COLUMNS.NAMA] || '').toString().trim();
      
      if (!nama) {
        continue;
      }
      
      var rowData = {};
      
      // ‚úÖ UPDATED: Map semua kolom A-Y (25 kolom) sesuai mapping baru
      var columns = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y'];
      
      for (var j = 0; j < Math.min(columns.length, row.length); j++) {
        var cellValue = row[j] || '';
        
        // Format tanggal khusus untuk kolom K (Jatuh Tempo) ‚úÖ UPDATED
        if (j === COLUMNS.JATUH_TEMPO && cellValue instanceof Date) {
          var day = cellValue.getDate().toString().padStart(2, '0');
          var month = (cellValue.getMonth() + 1).toString().padStart(2, '0');
          var year = cellValue.getFullYear();
          rowData[columns[j]] = day + '/' + month + '/' + year;
        } else if (cellValue instanceof Date) {
          var day = cellValue.getDate().toString().padStart(2, '0');
          var month = (cellValue.getMonth() + 1).toString().padStart(2, '0');
          var year = cellValue.getFullYear();
          rowData[columns[j]] = day + '/' + month + '/' + year;
        } else {
          rowData[columns[j]] = cellValue.toString().trim();
        }
      }
      
      // Tambahkan metadata
      rowData.rowNumber = i + 1;
      rowData.sheetName = 'Client Aktif';
      
      clientData.push(rowData);
    }
    
    Logger.log(`‚úÖ Successfully processed ${clientData.length} client records (ALL DATA from Client Aktif with updated mapping)`);
    
    return {
      status: 'success',
      data: clientData,
      totalRecords: clientData.length,
      lastUpdate: new Date().toISOString(),
      sheetName: 'Client Aktif',
      columnMapping: 'Updated to new structure with KIT Number (I) and Serial Number (J)'
    };
    
  } catch (error) {
    Logger.log('‚ùå Error in getAllClientDataComplete: ' + error.message);
    return {
      status: 'error',
      message: 'Error mengambil data: ' + error.message,
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * üîÑ UPDATED: Get Client Lepas Data dengan kolom mapping baru
 */
function getClientLepasData() {
  try {
    Logger.log('=== GET CLIENT LEPAS DATA START (UPDATED MAPPING) ===');
    
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = spreadsheet.getSheetByName("Client Lepas");
    
    if (!sheet) {
      return {
        status: 'error',
        message: 'Sheet "Client Lepas" tidak ditemukan'
      };
    }
    
    var data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return {
        status: 'success',
        data: [],
        message: 'Sheet kosong atau hanya ada header',
        totalRecords: 0
      };
    }
    
    var clientData = [];
    
    Logger.log(`Processing ${data.length - 1} total rows from Client Lepas sheet...`);
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var nama = (row[COLUMNS.NAMA] || '').toString().trim();
      
      if (!nama) {
        continue;
      }
      
      var rowData = {};
      
      // ‚úÖ UPDATED: Map semua kolom A-Y (25 kolom) sesuai mapping baru
      var columns = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y'];
      
      for (var j = 0; j < Math.min(columns.length, row.length); j++) {
        var cellValue = row[j] || '';
        
        // Format tanggal khusus untuk kolom K (Jatuh Tempo) ‚úÖ UPDATED
        if (j === COLUMNS.JATUH_TEMPO && cellValue instanceof Date) {
          var day = cellValue.getDate().toString().padStart(2, '0');
          var month = (cellValue.getMonth() + 1).toString().padStart(2, '0');
          var year = cellValue.getFullYear();
          rowData[columns[j]] = day + '/' + month + '/' + year;
        } else if (cellValue instanceof Date) {
          var day = cellValue.getDate().toString().padStart(2, '0');
          var month = (cellValue.getMonth() + 1).toString().padStart(2, '0');
          var year = cellValue.getFullYear();
          rowData[columns[j]] = day + '/' + month + '/' + year;
        } else {
          rowData[columns[j]] = cellValue.toString().trim();
        }
      }
      
      // Tambahkan metadata
      rowData.rowNumber = i + 1;
      rowData.sheetName = 'Client Lepas';
      
      clientData.push(rowData);
    }
    
    Logger.log(`‚úÖ Successfully processed ${clientData.length} client records (ALL DATA from Client Lepas with updated mapping)`);
    
    return {
      status: 'success',
      data: clientData,
      totalRecords: clientData.length,
      lastUpdate: new Date().toISOString(),
      sheetName: 'Client Lepas',
      columnMapping: 'Updated to new structure with KIT Number (I) and Serial Number (J)'
    };
    
  } catch (error) {
    Logger.log('‚ùå Error in getClientLepasData: ' + error.message);
    return {
      status: 'error',
      message: 'Error mengambil data: ' + error.message,
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * üîÑ UPDATED: Get Client Non Aktif Data dengan kolom mapping baru
 */
function getClientNonAktifData() {
  try {
    Logger.log('=== GET CLIENT NON AKTIF DATA START (UPDATED MAPPING) ===');
    
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = spreadsheet.getSheetByName("Client Non Aktif");
    
    if (!sheet) {
      return {
        status: 'error',
        message: 'Sheet "Client Non Aktif" tidak ditemukan'
      };
    }
    
    var data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return {
        status: 'success',
        data: [],
        message: 'Sheet kosong atau hanya ada header',
        totalRecords: 0
      };
    }
    
    var clientData = [];
    
    Logger.log(`Processing ${data.length - 1} total rows from Client Non Aktif sheet...`);
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      var nama = (row[COLUMNS.NAMA] || '').toString().trim();
      
      if (!nama) {
        continue;
      }
      
      var rowData = {};
      
      // ‚úÖ UPDATED: Map semua kolom A-Y (25 kolom) sesuai mapping baru
      var columns = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y'];
      
      for (var j = 0; j < Math.min(columns.length, row.length); j++) {
        var cellValue = row[j] || '';
        
        // Format tanggal khusus untuk kolom K (Jatuh Tempo) ‚úÖ UPDATED
        if (j === COLUMNS.JATUH_TEMPO && cellValue instanceof Date) {
          var day = cellValue.getDate().toString().padStart(2, '0');
          var month = (cellValue.getMonth() + 1).toString().padStart(2, '0');
          var year = cellValue.getFullYear();
          rowData[columns[j]] = day + '/' + month + '/' + year;
        } else if (cellValue instanceof Date) {
          var day = cellValue.getDate().toString().padStart(2, '0');
          var month = (cellValue.getMonth() + 1).toString().padStart(2, '0');
          var year = cellValue.getFullYear();
          rowData[columns[j]] = day + '/' + month + '/' + year;
        } else {
          rowData[columns[j]] = cellValue.toString().trim();
        }
      }
      
      // Tambahkan metadata
      rowData.rowNumber = i + 1;
      rowData.sheetName = 'Client Non Aktif';
      
      clientData.push(rowData);
    }
    
    Logger.log(`‚úÖ Successfully processed ${clientData.length} client records (ALL DATA from Client Non Aktif with updated mapping)`);
    
    return {
      status: 'success',
      data: clientData,
      totalRecords: clientData.length,
      lastUpdate: new Date().toISOString(),
      sheetName: 'Client Non Aktif',
      columnMapping: 'Updated to new structure with KIT Number (I) and Serial Number (J)'
    };
    
  } catch (error) {
    Logger.log('‚ùå Error in getClientNonAktifData: ' + error.message);
    return {
      status: 'error',
      message: 'Error mengambil data: ' + error.message,
      timestamp: new Date().toISOString()
    };
  }
}

function updateClientDataWithTransactionID(selectedKits, transactionID) {
  try {
    Logger.log('Updating client data with Transaction ID: ' + transactionID);
    
    var updateResult = { updated: [], notFound: [] };
    var clientSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Client Aktif");
    
    if (!clientSheet) {
      Logger.log('‚ùå Client Aktif sheet not found');
      return updateResult;
    }
    
    var data = clientSheet.getDataRange().getValues();
    
    selectedKits.forEach(function(kitInfo) {
      var kitNumber = kitInfo.kitNumber;
      var updated = false;
      
      for (var i = 1; i < data.length; i++) {
        var kitCell = data[i][COLUMNS.KIT_NUMBER]; // ‚úÖ NEW: Kolom I (KIT Number)
        
        if (kitCell) {
          var kitString = kitCell.toString().trim();
          var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];
          
          for (var j = 0; j < kitArray.length; j++) {
            if (kitArray[j].trim().toUpperCase() === kitNumber.toUpperCase()) {
              
              var currentTransactionID = data[i][COLUMNS.TRANSACTION_ID] || ''; // ‚úÖ NEW: Kolom N
              var newTransactionID;
              
              if (currentTransactionID && currentTransactionID.toString().trim()) {
                newTransactionID = currentTransactionID.toString().trim() + '\n' + transactionID;
              } else {
                newTransactionID = transactionID;
              }
              
              clientSheet.getRange(i + 1, COLUMNS.TRANSACTION_ID + 1).setValue(newTransactionID); // ‚úÖ NEW: Kolom N
              
              updateResult.updated.push({
                nama: data[i][COLUMNS.NAMA] || '',
                kit: kitNumber,
                sheet: 'Client Aktif',
                row: i + 1,
                transactionID: transactionID
              });
              
              updated = true;
              Logger.log(`‚úÖ Updated ${kitNumber} with Transaction ID: ${transactionID}`);
              break;
            }
          }
          
          if (updated) break;
        }
      }
      
      if (!updated) {
        updateResult.notFound.push(kitNumber);
        Logger.log(`‚ö†Ô∏è KIT not found in Client Aktif: ${kitNumber}`);
      }
    });
    
    Logger.log(`Client data update completed: ${updateResult.updated.length} updated, ${updateResult.notFound.length} not found`);
    return updateResult;
    
  } catch (error) {
    Logger.log('Error updating client data: ' + error.message);
    return {
      updated: [],
      notFound: selectedKits.map(kit => kit.kitNumber),
      error: error.message
    };
  }
}

// ========================================
// üîç 4. SEARCH HELPER FUNCTIONS
// ========================================

function buildMaskedData(data, rowIndex, sheetName) {
  var nama = data[rowIndex][COLUMNS.NAMA] || '-';
  var email = data[rowIndex][COLUMNS.LOGIN_STARLINK] || '-';
  var emailClient = data[rowIndex][COLUMNS.EMAIL_CLIENT] || '-'; 
  var nomorWA = data[rowIndex][COLUMNS.NOMOR_CS] || '-';
  var kitNumber = data[rowIndex][COLUMNS.KIT_NUMBER] || '-'; // ‚úÖ NEW
  var serialNumber = data[rowIndex][COLUMNS.SERIAL_NUMBER] || '-'; // ‚úÖ NEW
  var jatuhTempo = data[rowIndex][COLUMNS.JATUH_TEMPO] || '-'; // ‚úÖ NEW
  var transactionID = data[rowIndex][COLUMNS.TRANSACTION_ID] || '-';
  var status = data[rowIndex][COLUMNS.STATUS] || '-';
  var paket = data[rowIndex][COLUMNS.PAKET] || '-';
  var noRegister = data[rowIndex][COLUMNS.NO_REGISTER] || '-';
  
  var jatuhTempoFormatted = '-';
  if (jatuhTempo && jatuhTempo instanceof Date) {
    jatuhTempoFormatted = formatTanggalIndonesia(jatuhTempo);
  } else if (jatuhTempo && jatuhTempo !== '-') {
    var tempDate = new Date(jatuhTempo);
    if (!isNaN(tempDate.getTime())) {
      jatuhTempoFormatted = formatTanggalIndonesia(tempDate);
    }
  }
  
  var emailMasked = '-';
  if (email && email.includes('@')) {
    var emailParts = email.split('@');
    var localPart = emailParts[0];
    var domain = emailParts[1];
    emailMasked = localPart.substring(0, 3) + '***@' + domain;
  }
  
  var nomorWAMasked = '-';
  if (nomorWA && nomorWA.toString().length > 4) {
    nomorWAMasked = nomorWA.toString().substring(0, 4) + '****';
  }
  
  return {
    nama: nama,
    email: emailMasked,
    emailClient: emailClient,
    nomorWA: nomorWAMasked,
    kitNumber: kitNumber, // ‚úÖ NEW
    serialNumber: serialNumber, // ‚úÖ NEW
    jatuhTempo: jatuhTempoFormatted,
    transactionID: transactionID,
    status: status,
    paket: paket,
    noRegister: noRegister,
    statusClient: sheetName,
    rowNumber: rowIndex + 1
  };
}

function buildRowData(data, rowIndex, sheetName) {
  var rowData = {};
  var columns = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y'];
  
  for (var col = 0; col < 25; col++) {
    var cellValue = data[rowIndex][col] || '';
    
    if (cellValue instanceof Date) {
      if (col === COLUMNS.JATUH_TEMPO) { // ‚úÖ NEW: Kolom K
        cellValue = formatTanggalIndonesia(cellValue);
      } else {
        cellValue = cellValue.getDate() + '/' + (cellValue.getMonth() + 1) + '/' + cellValue.getFullYear();
      }
    }
    
    rowData[columns[col]] = cellValue.toString();
  }
  
  // ‚úÖ NEW: Gabungkan KIT Number & Paket
  var kitData = rowData['I'] || '';
  var paketData = rowData['P'] || '';
  var kitPaketCombined = '';
  
  if (kitData && paketData) {
    var kitLines = kitData.includes('\n') ? kitData.split('\n') : [kitData];
    var paketLines = paketData.includes('\n') ? paketData.split('\n') : [paketData];
    var combinedLines = [];
    var maxLines = Math.max(kitLines.length, paketLines.length);
    
    for (var k = 0; k < maxLines; k++) {
      var kit = kitLines[k] || kitLines[0] || '';
      var paket = paketLines[k] || paketLines[0] || '';
      combinedLines.push(kit.trim() + ' (' + paket.trim() + ')');
    }
    
    kitPaketCombined = combinedLines.join('\n');
  }
  
  rowData['I_P_COMBINED'] = kitPaketCombined; // ‚úÖ NEW
  rowData['statusClient'] = sheetName;
  rowData['rowNumber'] = rowIndex + 1;
  
  return rowData;
}

function buildResponse(data, rowIndex, headerRow, sheetName) {
  var rowData = {};
  var columns = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y'];
  
  for (var col = 0; col < 25; col++) {
    var cellValue = data[rowIndex][col] || '';
    
    if (cellValue instanceof Date) {
      if (col === COLUMNS.JATUH_TEMPO) { // ‚úÖ NEW: Kolom K
        cellValue = formatTanggalIndonesia(cellValue);
      } else {
        cellValue = cellValue.getDate() + '/' + (cellValue.getMonth() + 1) + '/' + cellValue.getFullYear();
      }
    }
    
    rowData[columns[col]] = cellValue.toString();
  }
  
  // ‚úÖ NEW: Gabungkan KIT & Paket
  var kitData = rowData['I'] || '';
  var paketData = rowData['P'] || '';
  var kitPaketCombined = '';
  
  if (kitData && paketData) {
    var kitLines = kitData.includes('\n') ? kitData.split('\n') : [kitData];
    var paketLines = paketData.includes('\n') ? paketData.split('\n') : [paketData];
    var combinedLines = [];
    var maxLines = Math.max(kitLines.length, paketLines.length);
    
    for (var k = 0; k < maxLines; k++) {
      var kit = kitLines[k] || kitLines[0] || '';
      var paket = paketLines[k] || paketLines[0] || '';
      combinedLines.push(kit.trim() + ' (' + paket.trim() + ')');
    }
    
    kitPaketCombined = combinedLines.join('\n');
  }
  
  rowData['I_P_COMBINED'] = kitPaketCombined; // ‚úÖ NEW
  
  return {
    status: 'success',
    data: {
      ...rowData,
      statusClient: sheetName
    },
    rowNumber: rowIndex + 1,
    headers: {
      'A': headerRow[0] || 'Nama',
      'B': headerRow[1] || 'Login GMAIL',
      'C': headerRow[2] || 'Login Starlink',
      'D': headerRow[3] || 'Login Alternatif',
      'E': headerRow[4] || 'ACC No.',
      'F': headerRow[5] || 'Email Client',
      'G': headerRow[6] || 'Nomor CS',
      'H': headerRow[7] || 'Alamat',
      'I': headerRow[8] || 'KIT Number', // ‚úÖ NEW
      'J': headerRow[9] || 'Serial Number', // ‚úÖ NEW
      'K': headerRow[10] || 'Tanggal Jatuh Tempo', // ‚úÖ NEW
      'L': headerRow[11] || 'Kode',
      'M': headerRow[12] || 'Payment',
      'N': headerRow[13] || 'ID Transaksi',
      'O': headerRow[14] || 'STATUS',
      'P': headerRow[15] || 'Paket',
      'Q': headerRow[16] || 'Last 4 Digit',
      'R': headerRow[17] || 'No Register',
      'S': headerRow[18] || 'Cadangan 1',
      'T': headerRow[19] || 'Cadangan 2',
      'U': headerRow[20] || 'JATUH TEMPO',
      'V': headerRow[21] || 'PROSES',
      'W': headerRow[22] || 'SEGERA',
      'X': headerRow[23] || 'OBSERVASI',
      'Y': headerRow[24] || 'Tombol WhatsApp'
    }
  };
}

function buildHeadersObject(headerRow) {
  return {
    'A': headerRow[0] || 'Nama',
    'B': headerRow[1] || 'Login GMAIL',
    'C': headerRow[2] || 'Login Starlink',
    'D': headerRow[3] || 'Login Alternatif',
    'E': headerRow[4] || 'ACC No.',
    'F': headerRow[5] || 'Email Client',
    'G': headerRow[6] || 'Nomor CS',
    'H': headerRow[7] || 'Alamat',
    'I': headerRow[8] || 'KIT Number', // ‚úÖ NEW
    'J': headerRow[9] || 'Serial Number', // ‚úÖ NEW
    'K': headerRow[10] || 'Tanggal Jatuh Tempo', // ‚úÖ NEW
    'L': headerRow[11] || 'Kode',
    'M': headerRow[12] || 'Payment',
    'N': headerRow[13] || 'ID Transaksi',
    'O': headerRow[14] || 'STATUS',
    'P': headerRow[15] || 'Paket',
    'Q': headerRow[16] || 'Last 4 Digit',
    'R': headerRow[17] || 'No Register',
    'S': headerRow[18] || 'Cadangan 1',
    'T': headerRow[19] || 'Cadangan 2',
    'U': headerRow[20] || 'JATUH TEMPO',
    'V': headerRow[21] || 'PROSES',
    'W': headerRow[22] || 'SEGERA',
    'X': headerRow[23] || 'OBSERVASI',
    'Y': headerRow[24] || 'Tombol WhatsApp'
  };
}

// ========================================
// üîç 5. SEARCH FUNCTIONS - ADMIN VERSION
// ========================================

// 5.1 KIT SEARCH FUNCTIONS
function searchByKit(kitNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
    
      for (var i = 1; i < data.length; i++) {
        var kitCell = data[i][COLUMNS.KIT_NUMBER]; // ‚úÖ NEW: Kolom I (KIT Number)
        
        var kitString = kitCell.toString().trim();
        var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];
        
        for (var j = 0; j < kitArray.length; j++) {
          if (kitArray[j].trim().toLowerCase() === kitNumber.toLowerCase()) {
            
            var nama = data[i][COLUMNS.NAMA] || '-';
            var email = data[i][COLUMNS.LOGIN_STARLINK] || '-';
            var emailClient = data[i][COLUMNS.EMAIL_CLIENT] || '-'; 
            var nomorWA = data[i][COLUMNS.NOMOR_CS] || '-';
            var kitNumber = data[i][COLUMNS.KIT_NUMBER] || '-'; // ‚úÖ NEW
            var serialNumber = data[i][COLUMNS.SERIAL_NUMBER] || '-'; // ‚úÖ NEW
            var jatuhTempo = data[i][COLUMNS.JATUH_TEMPO] || '-'; // ‚úÖ NEW
            var transactionID = data[i][COLUMNS.TRANSACTION_ID] || '-';
            var status = data[i][COLUMNS.STATUS] || '-';
            var paket = data[i][COLUMNS.PAKET] || '-';
            var noRegister = data[i][COLUMNS.NO_REGISTER] || '-';
            
            var jatuhTempoFormatted = '-';
            if (jatuhTempo && jatuhTempo instanceof Date) {
              jatuhTempoFormatted = formatTanggalIndonesia(jatuhTempo);
            } else if (jatuhTempo && jatuhTempo !== '-') {
              var tempDate = new Date(jatuhTempo);
              if (!isNaN(tempDate.getTime())) {
                jatuhTempoFormatted = formatTanggalIndonesia(tempDate);
              }
            }
            
            var emailMasked = '-';
            if (email && email.includes('@')) {
              var emailParts = email.split('@');
              var localPart = emailParts[0];
              var domain = emailParts[1];
              emailMasked = localPart.substring(0, 3) + '***@' + domain;
            }
            
            var nomorWAMasked = '-';
            if (nomorWA && nomorWA.toString().length > 4) {
              nomorWAMasked = nomorWA.toString().substring(0, 4) + '****';
            }
            
            return {
              status: 'success',
              data: {
                nama: nama,
                email: emailMasked,
                emailClient: emailClient,
                nomorWA: nomorWAMasked,
                kitNumber: kitNumber, // ‚úÖ NEW
                serialNumber: serialNumber, // ‚úÖ NEW
                jatuhTempo: jatuhTempoFormatted,
                transactionID: transactionID,
                status: status,
                paket: paket,
                noRegister: noRegister,
                statusClient: sheetName,
                rowNumber: i + 1
              }
            };
          }
        }
      }
    }

    return { status: 'not_found', message: 'Nomor kit tidak ditemukan dalam database' };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByKitAdmin(kitNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      for (var i = 1; i < data.length; i++) {
        var kitCell = data[i][COLUMNS.KIT_NUMBER]; // ‚úÖ NEW: Kolom I (KIT Number)
        
        var kitString = kitCell.toString().trim();
        var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];
        
        for (var j = 0; j < kitArray.length; j++) {
          if (kitArray[j].trim().toLowerCase() === kitNumber.toLowerCase()) {
            return buildResponse(data, i, headerRow, sheetName);
          }
        }
      }
    }
    
    return { status: 'not_found', message: 'Nomor kit tidak ditemukan dalam database' };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByKitAdminMultiple(kitNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    var headers = {};
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      if (Object.keys(headers).length === 0) {
        headers = buildHeadersObject(headerRow);
      }
      
      for (var i = 1; i < data.length; i++) {
        var kitCell = data[i][COLUMNS.KIT_NUMBER]; // ‚úÖ NEW: Kolom I (KIT Number)
        
        var kitString = kitCell.toString().trim();
        var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];
        
        for (var j = 0; j < kitArray.length; j++) {
          if (kitArray[j].trim().toLowerCase() === kitNumber.toLowerCase()) {
            var rowData = buildRowData(data, i, sheetName);
            allResults.push(rowData);
            break;
          }
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Nomor kit tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults,
      headers: headers
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByKitMultiple(kitNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var kitCell = data[i][COLUMNS.KIT_NUMBER]; // ‚úÖ NEW: Kolom I (KIT Number)
        
        var kitString = kitCell.toString().trim();
        var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];
        
        for (var j = 0; j < kitArray.length; j++) {
          if (kitArray[j].trim().toLowerCase() === kitNumber.toLowerCase()) {
            var maskedData = buildMaskedData(data, i, sheetName);
            allResults.push(maskedData);
            break;
          }
        }
      }
    }

    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Nomor kit tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 5.2 ‚úÖ NEW: SERIAL NUMBER SEARCH FUNCTIONS
function searchBySerialNumber(serialNumber) {
  try {
    Logger.log('üîç Searching by Serial Number: ' + serialNumber);
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (!sheet) continue;
      
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      for (var i = 1; i < data.length; i++) {
        var serialCell = data[i][COLUMNS.SERIAL_NUMBER]; // J: Serial Number
        
        if (!serialCell) continue;
        
        var serialString = serialCell.toString().trim();
        var serialArray = serialString.includes('\n') ? serialString.split('\n') : [serialString];
        
        for (var j = 0; j < serialArray.length; j++) {
          if (serialArray[j].trim().toLowerCase() === serialNumber.toLowerCase()) {
            Logger.log('‚úÖ Serial Number found in ' + sheetName + ' at row ' + (i + 1));
            return buildResponse(data, i, headerRow, sheetName);
          }
        }
      }
    }
    
    Logger.log('‚ùå Serial Number not found: ' + serialNumber);
    return { status: 'not_found', message: 'Serial Number tidak ditemukan dalam database' };
    
  } catch (error) {
    Logger.log('‚ùå Error in searchBySerialNumber: ' + error.message);
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchBySerialNumberMultiple(serialNumber) {
  try {
    Logger.log('üîç Searching by Serial Number (Multiple): ' + serialNumber);
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    var headers = {};
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (!sheet) continue;
      
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      if (Object.keys(headers).length === 0) {
        headers = buildHeadersObject(headerRow);
      }
      
      for (var i = 1; i < data.length; i++) {
        var serialCell = data[i][COLUMNS.SERIAL_NUMBER]; // J: Serial Number
        
        if (!serialCell) continue;
        
        var serialString = serialCell.toString().trim();
        var serialArray = serialString.includes('\n') ? serialString.split('\n') : [serialString];
        
        for (var j = 0; j < serialArray.length; j++) {
          if (serialArray[j].trim().toLowerCase() === serialNumber.toLowerCase()) {
            var rowData = buildRowData(data, i, sheetName);
            allResults.push(rowData);
            Logger.log('‚úÖ Serial Number found in ' + sheetName + ' at row ' + (i + 1));
            break;
          }
        }
      }
    }
    
    if (allResults.length === 0) {
      Logger.log('‚ùå Serial Number not found: ' + serialNumber);
      return { status: 'not_found', message: 'Serial Number tidak ditemukan dalam database' };
    }
    
    Logger.log('‚úÖ Serial Number search completed: ' + allResults.length + ' results found');
    return {
      status: 'success',
      data: allResults,
      headers: headers
    };
    
  } catch (error) {
    Logger.log('‚ùå Error in searchBySerialNumberMultiple: ' + error.message);
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 5.3 EMAIL SEARCH FUNCTIONS
function searchByEmailClient(emailClient) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      for (var i = 1; i < data.length; i++) {
        var emailCell = data[i][COLUMNS.EMAIL_CLIENT]; // Kolom F: Email Client
        
        if (emailCell && emailCell.toString().toLowerCase().includes(emailClient.toLowerCase())) {
          return buildResponse(data, i, headerRow, sheetName);
        }
      }
    }
    
    return { status: 'not_found', message: 'Email client tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByEmailClientMultiple(emailClient) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    var headers = {};
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      if (Object.keys(headers).length === 0) {
        headers = buildHeadersObject(headerRow);
      }
      
      for (var i = 1; i < data.length; i++) {
        var emailCell = data[i][COLUMNS.EMAIL_CLIENT]; // Kolom F: Email Client
        
        if (emailCell && emailCell.toString().toLowerCase().includes(emailClient.toLowerCase())) {
          var rowData = buildRowData(data, i, sheetName);
          allResults.push(rowData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Email client tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults,
      headers: headers
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 5.4 PHONE SEARCH FUNCTIONS
function searchByNomorCS(nomorCS) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      for (var i = 1; i < data.length; i++) {
        var phoneCell = data[i][COLUMNS.NOMOR_CS]; // Kolom G: Nomor CS
        
        var phoneString = phoneCell.toString().replace(/\D/g, '');
        var searchString = nomorCS.replace(/\D/g, '');
        
        if (phoneString.includes(searchString)) {
          return buildResponse(data, i, headerRow, sheetName);
        }
      }
    }
    
    return { status: 'not_found', message: 'Nomor CS tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByNomorCSMultiple(nomorCS) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    var headers = {};
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      if (Object.keys(headers).length === 0) {
        headers = buildHeadersObject(headerRow);
      }
      
      for (var i = 1; i < data.length; i++) {
        var phoneCell = data[i][COLUMNS.NOMOR_CS]; // Kolom G: Nomor CS
        
        var phoneString = phoneCell.toString().replace(/\D/g, '');
        var searchString = nomorCS.replace(/\D/g, '');
        
        if (phoneString.includes(searchString)) {
          var rowData = buildRowData(data, i, sheetName);
          allResults.push(rowData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Nomor CS tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults,
      headers: headers
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 5.5 LOGIN STARLINK SEARCH FUNCTIONS
function searchByLoginStarlink(loginStarlink) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      for (var i = 1; i < data.length; i++) {
        var loginCell = data[i][COLUMNS.LOGIN_STARLINK]; // Kolom C: Login Starlink
        
        if (loginCell && loginCell.toString().toLowerCase().includes(loginStarlink.toLowerCase())) {
          return buildResponse(data, i, headerRow, sheetName);
        }
      }
    }
    
    return { status: 'not_found', message: 'Login Starlink tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByLoginStarlinkMultiple(loginStarlink) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    var headers = {};
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      if (Object.keys(headers).length === 0) {
        headers = buildHeadersObject(headerRow);
      }
      
      for (var i = 1; i < data.length; i++) {
        var loginCell = data[i][COLUMNS.LOGIN_STARLINK]; // Kolom C: Login Starlink
        
        if (loginCell && loginCell.toString().toLowerCase().includes(loginStarlink.toLowerCase())) {
          var rowData = buildRowData(data, i, sheetName);
          allResults.push(rowData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Login Starlink tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults,
      headers: headers
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 5.6 ACCOUNT NUMBER SEARCH FUNCTIONS
function searchByAccountNumber(accountNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      for (var i = 1; i < data.length; i++) {
        var accountCell = data[i][COLUMNS.ACC_NO]; // Kolom E: Account Number
        
        if (accountCell && accountCell.toString().toLowerCase().includes(accountNumber.toLowerCase())) {
          return buildResponse(data, i, headerRow, sheetName);
        }
      }
    }
    
    return { status: 'not_found', message: 'Account Number tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByAccountNumberMultiple(accountNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    var headers = {};
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      if (Object.keys(headers).length === 0) {
        headers = buildHeadersObject(headerRow);
      }
      
      for (var i = 1; i < data.length; i++) {
        var accountCell = data[i][COLUMNS.ACC_NO]; // Kolom E: Account Number
        
        if (accountCell && accountCell.toString().toLowerCase().includes(accountNumber.toLowerCase())) {
          var rowData = buildRowData(data, i, sheetName);
          allResults.push(rowData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Account Number tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults,
      headers: headers
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 5.7 NAME SEARCH FUNCTIONS
function searchByNama(nama) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      for (var i = 1; i < data.length; i++) {
        var namaCell = data[i][COLUMNS.NAMA]; // Kolom A: Nama
        
        if (namaCell && namaCell.toString().toLowerCase().includes(nama.toLowerCase())) {
          return buildResponse(data, i, headerRow, sheetName);
        }
      }
    }
    
    return { status: 'not_found', message: 'Nama tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByNamaMultiple(nama) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    var headers = {};
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      var headerRow = data[0];
      
      if (Object.keys(headers).length === 0) {
        headers = buildHeadersObject(headerRow);
      }
      
      for (var i = 1; i < data.length; i++) {
        var namaCell = data[i][COLUMNS.NAMA]; // Kolom A: Nama
        
        if (namaCell && namaCell.toString().toLowerCase().includes(nama.toLowerCase())) {
          var rowData = buildRowData(data, i, sheetName);
          allResults.push(rowData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Nama tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults,
      headers: headers
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// ========================================
// üîç 6. SEARCH FUNCTIONS - CUSTOMER VERSION (with data masking)
// ========================================

// 6.1 CUSTOMER EMAIL SEARCH
function searchByEmailClientCustomer(emailClient) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var emailCell = data[i][COLUMNS.EMAIL_CLIENT]; // Kolom F: Email Client
        
        if (emailCell && emailCell.toString().toLowerCase().includes(emailClient.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          return {
            status: 'success',
            data: maskedData
          };
        }
      }
    }
    
    return { status: 'not_found', message: 'Email client tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByEmailClientCustomerMultiple(emailClient) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var emailCell = data[i][COLUMNS.EMAIL_CLIENT]; // Kolom F: Email Client
        
        if (emailCell && emailCell.toString().toLowerCase().includes(emailClient.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          allResults.push(maskedData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Email client tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 6.2 ‚úÖ NEW: CUSTOMER SERIAL NUMBER SEARCH
function searchBySerialNumberCustomer(serialNumber) {
  try {
    Logger.log('üîç Searching by Serial Number (Customer): ' + serialNumber);
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (!sheet) continue;
      
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var serialCell = data[i][COLUMNS.SERIAL_NUMBER]; // J: Serial Number
        
        if (!serialCell) continue;
        
        var serialString = serialCell.toString().trim();
        var serialArray = serialString.includes('\n') ? serialString.split('\n') : [serialString];
        
        for (var j = 0; j < serialArray.length; j++) {
          if (serialArray[j].trim().toLowerCase() === serialNumber.toLowerCase()) {
            var maskedData = buildMaskedData(data, i, sheetName);
            Logger.log('‚úÖ Serial Number found (Customer): ' + serialNumber);
            return {
              status: 'success',
              data: maskedData
            };
          }
        }
      }
    }
    
    Logger.log('‚ùå Serial Number not found (Customer): ' + serialNumber);
    return { status: 'not_found', message: 'Serial Number tidak ditemukan dalam database' };
    
  } catch (error) {
    Logger.log('‚ùå Error in searchBySerialNumberCustomer: ' + error.message);
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchBySerialNumberCustomerMultiple(serialNumber) {
  try {
    Logger.log('üîç Searching by Serial Number (Customer Multiple): ' + serialNumber);
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (!sheet) continue;
      
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var serialCell = data[i][COLUMNS.SERIAL_NUMBER]; // J: Serial Number
        
        if (!serialCell) continue;
        
        var serialString = serialCell.toString().trim();
        var serialArray = serialString.includes('\n') ? serialString.split('\n') : [serialString];
        
        for (var j = 0; j < serialArray.length; j++) {
          if (serialArray[j].trim().toLowerCase() === serialNumber.toLowerCase()) {
            var maskedData = buildMaskedData(data, i, sheetName);
            allResults.push(maskedData);
            Logger.log('‚úÖ Serial Number found (Customer): ' + serialNumber);
            break;
          }
        }
      }
    }
    
    if (allResults.length === 0) {
      Logger.log('‚ùå Serial Number not found (Customer): ' + serialNumber);
      return { status: 'not_found', message: 'Serial Number tidak ditemukan dalam database' };
    }
    
    Logger.log('‚úÖ Serial Number search completed (Customer): ' + allResults.length + ' results found');
    return {
      status: 'success',
      data: allResults
    };
    
  } catch (error) {
    Logger.log('‚ùå Error in searchBySerialNumberCustomerMultiple: ' + error.message);
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 6.3 CUSTOMER PHONE SEARCH
function searchByNomorCSCustomer(nomorCS) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var phoneCell = data[i][COLUMNS.NOMOR_CS]; // Kolom G: Nomor CS
        
        var phoneString = phoneCell.toString().replace(/\D/g, '');
        var searchString = nomorCS.replace(/\D/g, '');
        
        if (phoneString.includes(searchString)) {
          var maskedData = buildMaskedData(data, i, sheetName);
          return {
            status: 'success',
            data: maskedData
          };
        }
      }
    }
    
    return { status: 'not_found', message: 'Nomor CS tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByNomorCSCustomerMultiple(nomorCS) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var phoneCell = data[i][COLUMNS.NOMOR_CS]; // Kolom G: Nomor CS
        
        var phoneString = phoneCell.toString().replace(/\D/g, '');
        var searchString = nomorCS.replace(/\D/g, '');
        
        if (phoneString.includes(searchString)) {
          var maskedData = buildMaskedData(data, i, sheetName);
          allResults.push(maskedData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Nomor CS tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 6.4 CUSTOMER LOGIN SEARCH
function searchByLoginStarlinkCustomer(loginStarlink) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var loginCell = data[i][COLUMNS.LOGIN_STARLINK]; // Kolom C: Login Starlink
        
        if (loginCell && loginCell.toString().toLowerCase().includes(loginStarlink.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          return {
            status: 'success',
            data: maskedData
          };
        }
      }
    }
    
    return { status: 'not_found', message: 'Login Starlink tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByLoginStarlinkCustomerMultiple(loginStarlink) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var loginCell = data[i][COLUMNS.LOGIN_STARLINK]; // Kolom C: Login Starlink
        
        if (loginCell && loginCell.toString().toLowerCase().includes(loginStarlink.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          allResults.push(maskedData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Login Starlink tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 6.5 CUSTOMER ACCOUNT SEARCH
function searchByAccountNumberCustomer(accountNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var accountCell = data[i][COLUMNS.ACC_NO]; // Kolom E: Account Number
        
        if (accountCell && accountCell.toString().toLowerCase().includes(accountNumber.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          return {
            status: 'success',
            data: maskedData
          };
        }
      }
    }
    
    return { status: 'not_found', message: 'Account Number tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByAccountNumberCustomerMultiple(accountNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var accountCell = data[i][COLUMNS.ACC_NO]; // Kolom E: Account Number
        
        if (accountCell && accountCell.toString().toLowerCase().includes(accountNumber.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          allResults.push(maskedData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Account Number tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// 6.6 CUSTOMER NAME SEARCH
function searchByNamaCustomer(nama) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var namaCell = data[i][COLUMNS.NAMA]; // Kolom A: Nama
        
        if (namaCell && namaCell.toString().toLowerCase().includes(nama.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          return {
            status: 'success',
            data: maskedData
          };
        }
      }
    }
    
    return { status: 'not_found', message: 'Nama tidak ditemukan dalam database' };
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

function searchByNamaCustomerMultiple(nama) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];    
    var allResults = [];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var namaCell = data[i][COLUMNS.NAMA]; // Kolom A: Nama
        
        if (namaCell && namaCell.toString().toLowerCase().includes(nama.toLowerCase())) {
          var maskedData = buildMaskedData(data, i, sheetName);
          allResults.push(maskedData);
        }
      }
    }
    
    if (allResults.length === 0) {
      return { status: 'not_found', message: 'Nama tidak ditemukan dalam database' };
    }
    
    return {
      status: 'success',
      data: allResults
    };
    
  } catch (error) {
    return { status: 'error', message: 'Error dalam pencarian: ' + error.message };
  }
}

// ========================================
// üîç 7. UNIVERSAL SEARCH FUNCTION
// ========================================

function universalSearch(searchTerm) {
  try {
    Logger.log('Universal search for: ' + searchTerm);
    
    var allResults = [];
    var searchSources = [];
    
    // Search by Kit
    try {
      var kitResult = searchByKitAdminMultiple(searchTerm);
      if (kitResult.status === 'success') {
        allResults = allResults.concat(kitResult.data.map(item => ({
          ...item,
          searchSource: 'KIT Number' // ‚úÖ NEW
        })));
        searchSources.push('KIT Number');
      }
    } catch (e) {
      Logger.log('Kit search error: ' + e.message);
    }
    
    // ‚úÖ NEW: Search by Serial Number
    try {
      var serialResult = searchBySerialNumberMultiple(searchTerm);
      if (serialResult.status === 'success') {
        allResults = allResults.concat(serialResult.data.map(item => ({
          ...item,
          searchSource: 'Serial Number'
        })));
        searchSources.push('Serial Number');
      }
    } catch (e) {
      Logger.log('Serial search error: ' + e.message);
    }
    
    // Search by Login
    try {
      var loginResult = searchByLoginStarlinkMultiple(searchTerm);
      if (loginResult.status === 'success') {
        allResults = allResults.concat(loginResult.data.map(item => ({
          ...item,
          searchSource: 'Login Starlink'
        })));
        searchSources.push('Login Starlink');
      }
    } catch (e) {
      Logger.log('Login search error: ' + e.message);
    }
    
    // Search by Email
    try {
      var emailResult = searchByEmailClientMultiple(searchTerm);
      if (emailResult.status === 'success') {
        allResults = allResults.concat(emailResult.data.map(item => ({
          ...item,
          searchSource: 'Email Client'
        })));
        searchSources.push('Email Client');
      }
    } catch (e) {
      Logger.log('Email search error: ' + e.message);
    }
    
    // Search by Phone
    try {
      var phoneResult = searchByNomorCSMultiple(searchTerm);
      if (phoneResult.status === 'success') {
        allResults = allResults.concat(phoneResult.data.map(item => ({
          ...item,
          searchSource: 'Nomor CS'
        })));
        searchSources.push('Nomor CS');
      }
    } catch (e) {
      Logger.log('Phone search error: ' + e.message);
    }
    
    // Search by Account
    try {
      var accountResult = searchByAccountNumberMultiple(searchTerm);
      if (accountResult.status === 'success') {
        allResults = allResults.concat(accountResult.data.map(item => ({
          ...item,
          searchSource: 'Account Number'
        })));
        searchSources.push('Account Number');
      }
    } catch (e) {
      Logger.log('Account search error: ' + e.message);
    }
    
    // Search by Name
    try {
      var nameResult = searchByNamaMultiple(searchTerm);
      if (nameResult.status === 'success') {
        allResults = allResults.concat(nameResult.data.map(item => ({
          ...item,
          searchSource: 'Nama Client'
        })));
        searchSources.push('Nama Client');
      }
    } catch (e) {
      Logger.log('Name search error: ' + e.message);
    }
    
    // Remove duplicates based on row number and sheet
    var uniqueResults = [];
    var seen = new Set();
    
    allResults.forEach(item => {
      var key = item.statusClient + '_' + item.rowNumber;
      if (!seen.has(key)) {
        seen.add(key);
        uniqueResults.push(item);
      }
    });
    
    if (uniqueResults.length === 0) {
      return {
        status: 'not_found',
        message: 'Tidak ada data yang ditemukan untuk: ' + searchTerm,
        searchedIn: ['KIT Number', 'Serial Number', 'Login Starlink', 'Email Client', 'Nomor CS', 'Account Number', 'Nama Client'] // ‚úÖ UPDATED
      };
    }
    
    return {
      status: 'success',
      data: uniqueResults,
      totalResults: uniqueResults.length,
      searchSources: searchSources,
      searchTerm: searchTerm
    };
    
  } catch (error) {
    return {
      status: 'error',
      message: 'Error dalam universal search: ' + error.message
    };
  }
}

// ========================================
// üì± 8. WHATSAPP REMINDER FUNCTIONS
// ========================================

/**
 * üîÑ UPDATED: Main WhatsApp function dengan kolom mapping baru
 */
function kirimWhatsApp() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

  // Hapus filter jika ada
  if (sheet.getFilter()) {
    sheet.getFilter().remove();
  }

  // Delay 3 detik
  Utilities.sleep(3000);

  var data = sheet.getDataRange().getValues();
  var headerRow = data[0];
  var waColumnIndex = -1;
  
  // ‚úÖ UPDATED: Column indices sesuai mapping baru
  var tandaColumnIndex = COLUMNS.LABEL_JATUH_TEMPO; // U: "Jatuh Tempo"
  var statusColumnIndex = COLUMNS.STATUS; // O: Status "Lunas"
  var linkColumnIndex = COLUMNS.TOMBOL_WHATSAPP; // Y: Link WA
  var prosesColumnIndex = COLUMNS.LABEL_PROSES; // V: "PROSES"
  var segaraColumnIndex = COLUMNS.LABEL_SEGERA; // W: "SEGERA"
  var observasiColumnIndex = COLUMNS.LABEL_OBSERVASI; // X: "OBSERVASI"
  
  // ‚úÖ FIX: Gunakan object untuk logs agar bisa dimodifikasi by reference
  var logs = {
    clientProsesLog: "CLIENT YANG PROSES HARI INI:\n\n",
    clientReminderH3Log: "CLIENT YANG HARUS REMINDER H-3 HARI INI:\n\n",
    clientReminderH2Log: "CLIENT YANG HARUS REMINDER H-2 HARI INI:\n\n",
    clientReminderH1Log: "CLIENT YANG HARUS REMINDER H-1 HARI INI:\n\n",
    clientJatuhTempoLog: "CLIENT YANG JATUH TEMPO DAN BELUM:\n\n",
    clientWarningLog: "CLIENT WARNING - HARI H (AKAN MATI HARI INI):\n\n",
    errorLog: ""
  };

  // Cari kolom untuk Tombol WhatsApp
  for (var c = 0; c < headerRow.length; c++) {
    if (headerRow[c].toString().trim().toLowerCase() === "tombol whatsapp") {
      waColumnIndex = c + 1;
      break;
    }
  }

  // Jika belum ada, buat kolom "Tombol WhatsApp"
  if (waColumnIndex === -1) {
    waColumnIndex = sheet.getLastColumn() + 1;
    sheet.getRange(1, waColumnIndex).setValue("Tombol WhatsApp").setFontWeight("bold").setHorizontalAlignment("center");
  }

  var today = new Date();
  today.setHours(0, 0, 0, 0);

  Logger.log("Memulai perulangan baris data...");

  // Generate link WA untuk H-3 dan HARI H
  for (var i = 1; i < data.length; i++) {
    var nama = data[i][COLUMNS.NAMA];  // A: Nama
    var email = data[i][COLUMNS.LOGIN_STARLINK]; // C: Login Starlink
    var nomorWA = data[i][COLUMNS.NOMOR_CS]; // G: Nomor WA
    var kitNumber = data[i][COLUMNS.KIT_NUMBER]; // I: KIT Number ‚úÖ NEW
    var serialNumber = data[i][COLUMNS.SERIAL_NUMBER]; // J: Serial Number ‚úÖ NEW
    var jatuhTempoRaw = data[i][COLUMNS.JATUH_TEMPO]; // K: Jatuh Tempo ‚úÖ MOVED
    var paket = data[i][COLUMNS.PAKET]; // P: Paket ‚úÖ MOVED
    var status = data[i][statusColumnIndex]; // O: Status ‚úÖ MOVED
    var tipePelanggan = data[i][COLUMNS.TIPE_PELANGGAN]; // S: Tipe Pelanggan ‚úÖ NEW
    
    // ‚úÖ UPDATED: Cell references dengan kolom baru
    var tandaCell = sheet.getRange(i + 1, tandaColumnIndex + 1); // U: Tanda "Jatuh Tempo"
    var cell = sheet.getRange(i + 1, waColumnIndex);
    var prosesCell = sheet.getRange(i + 1, prosesColumnIndex + 1); // V: PROSES
    var segaraCell = sheet.getRange(i + 1, segaraColumnIndex + 1); // W: SEGERA
    var observasiCell = sheet.getRange(i + 1, observasiColumnIndex + 1); // X: OBSERVASI

    // Validasi hanya untuk field wajib (nama + tanggal)
    if (!nama || !jatuhTempoRaw) {
      var logWajib = `‚ùå Baris ke-${i + 1} dilewati karena data wajib tidak lengkap:`;
      if (!nama) logWajib += "\n   - Nama: [Kosong]";
      if (!jatuhTempoRaw) logWajib += "\n   - Jatuh Tempo: [Kosong]";
      
      Logger.log(logWajib);
      logs.errorLog += logWajib + "\n";
      
      // Clear semua status karena data wajib tidak lengkap
      tandaCell.setValue("");
      cell.setValue("").setFormula("");
      prosesCell.setValue("");
      segaraCell.setValue("");
      observasiCell.setValue("");
      continue;
    }

    // Validasi tanggal
    var jatuhTempoDate = new Date(jatuhTempoRaw);
    if (isNaN(jatuhTempoDate.getTime())) {
      var logTanggal = `‚ùå Baris ke-${i + 1} dilewati karena format tanggal tidak valid.`;
      Logger.log(logTanggal);
      logs.errorLog += logTanggal + "\n";
      
      // Clear semua status karena tanggal invalid
      tandaCell.setValue("");
      cell.setValue("").setFormula("");
      prosesCell.setValue("");
      segaraCell.setValue("");
      observasiCell.setValue("");
      continue;
    }

    // Validasi untuk field optional (tetap catat tapi tidak skip)
    var logOptional = `‚ö†Ô∏è Baris ke-${i + 1} data tidak lengkap (tetap diproses):`;
    var adaOptionalKosong = false;
    if (!email) { logOptional += "\n   - Email: [Kosong]"; adaOptionalKosong = true; }
    if (!nomorWA) { logOptional += "\n   - Nomor WA: [Kosong]"; adaOptionalKosong = true; }
    if (!kitNumber) { logOptional += "\n   - KIT Number: [Kosong]"; adaOptionalKosong = true; }
    if (!paket) { logOptional += "\n   - Paket: [Kosong]"; adaOptionalKosong = true; }

    if (adaOptionalKosong) {
      Logger.log(logOptional);
      logs.errorLog += logOptional + "\n";
    }

    jatuhTempoDate.setHours(0, 0, 0, 0);
    var selisihHari = Math.floor((jatuhTempoDate - today) / (1000 * 60 * 60 * 24));

    // Cek apakah status adalah "Pending"
    if (status.toString().trim().toLowerCase() === "pending") {
      observasiCell.setValue("OBSERVASI")
                   .setFontWeight("bold")
                   .setFontSize(13)
                   .setHorizontalAlignment("center")
                   .setVerticalAlignment("middle");
    } else {
      observasiCell.setValue("");
    }

    // Label "JATUH TEMPO"
    if (selisihHari === 0) {
      tandaCell.setValue("JATUH TEMPO").setFontWeight("bold").setFontColor("#1F497D").setFontSize(13).setHorizontalAlignment("center").setVerticalAlignment("middle");
    } else {
      tandaCell.setValue("");
    }

    // Status "Belum"
    if (status.toString().trim().toLowerCase() === "belum") {
      if (tandaCell.getValue() === "JATUH TEMPO") {
        logs.clientJatuhTempoLog += `${i + 1}. - ${nama} | ${email || 'N/A'} | ${nomorWA || 'N/A'} | ${kitNumber || 'N/A'}\n\n`;
      }
    }

    // Label "PROSES" jika tanggal jatuh tempo + 1 hari
    var jatuhTempoPlusOne = new Date(jatuhTempoDate);
    jatuhTempoPlusOne.setDate(jatuhTempoPlusOne.getDate() + 1);
    if (jatuhTempoPlusOne.getTime() === today.getTime()) {
      prosesCell.setValue("PROSES").setFontWeight("bold").setFontColor("#1F497D").setFontSize(13).setHorizontalAlignment("center").setVerticalAlignment("middle");
      logs.clientProsesLog += `${i + 1}. - ${nama} | ${email || 'N/A'} | ${nomorWA || 'N/A'} | ${kitNumber || 'N/A'}\n\n`;
    } else {
      prosesCell.setValue("");
    }

    // Label "SEGERA" jika status Lunas atau "Rencana Bayarkan" dan sudah lewat jatuh tempo
    if ((status.toString().trim().toLowerCase() === "lunas" || status.toString().trim().toLowerCase() === "rencana bayarkan") && jatuhTempoDate < today) {
      segaraCell.setValue("SEGERA")
                .setFontWeight("bold")
                .setFontColor("#003366")
                .setFontSize(13)
                .setHorizontalAlignment("center")
                .setVerticalAlignment("middle");
    } else {
      segaraCell.setValue("");
    }

    // Helper function untuk cek status yang memenuhi syarat
    function isEligibleStatus(status) {
      var statusLower = status.toString().trim().toLowerCase();
      return statusLower === "belum" || 
             statusLower === "active" || 
             statusLower === "pending reminder" || 
             statusLower === ""; // kosong
    }

    // ‚úÖ FIX: Process reminder logic dengan logs object yang bisa dimodifikasi
    processReminderLogic(selisihHari, isEligibleStatus(status), {
      nama: nama,
      nomorWA: nomorWA,
      kitNumber: kitNumber,
      serialNumber: serialNumber,
      paket: paket,
      jatuhTempoDate: jatuhTempoDate,
      status: status,
      tipePelanggan: tipePelanggan,
      cell: cell,
      i: i
    }, logs); // ‚úÖ Pass logs object by reference
  }

  // Send consolidated email
  sendConsolidatedEmail(logs);

  // Reactivate filter
  reactivateFilter(sheet);
}

/**
 * ‚úÖ FIXED: Process reminder logic (now properly modifies logs object)
 */
function processReminderLogic(selisihHari, isEligible, clientData, logs) {
  var { nama, nomorWA, kitNumber, serialNumber, paket, jatuhTempoDate, status, tipePelanggan, cell, i } = clientData;
  
  if (selisihHari === 3) {
    // H-3: Reminder H-3
    if (isEligible) {
      if (nomorWA) {
        var waLinkH3 = generateWhatsAppLink(nama, nomorWA, kitNumber, serialNumber, paket, jatuhTempoDate, 'H-3', tipePelanggan);
        setReminderCell(cell, "üìÖ Reminder H-3", waLinkH3, "#2563eb");
        logs.clientReminderH3Log += `${i + 1}. - ${nama} (H-3, Status: ${status}) | ${waLinkH3}\n\n`;
      } else {
        setReminderCell(cell, "üìÖ H-3 (No WA)", null, "#2563eb");
        logs.clientReminderH3Log += `${i + 1}. - ${nama} (H-3, Status: ${status}) | [NO WA]\n\n`;
      }
    } else {
      cell.setValue("").setFormula("");
    }
  } else if (selisihHari === 2) {
    // H-2: Reminder H-2
    if (isEligible) {
      if (nomorWA) {
        var waLinkH2 = generateWhatsAppLink(nama, nomorWA, kitNumber, serialNumber, paket, jatuhTempoDate, 'H-2', tipePelanggan);
        setReminderCell(cell, "‚ö†Ô∏è Reminder H-2", waLinkH2, "#f59e0b");
        logs.clientReminderH2Log += `${i + 1}. - ${nama} (H-2, Status: ${status}) | ${waLinkH2}\n\n`;
      } else {
        setReminderCell(cell, "‚ö†Ô∏è H-2 (No WA)", null, "#f59e0b");
        logs.clientReminderH2Log += `${i + 1}. - ${nama} (H-2, Status: ${status}) | [NO WA]\n\n`;
      }
    } else {
      cell.setValue("").setFormula("");
    }
  } else if (selisihHari === 1) {
    // H-1: Reminder H-1
    if (isEligible) {
      if (nomorWA) {
        var waLinkH1 = generateWhatsAppLink(nama, nomorWA, kitNumber, serialNumber, paket, jatuhTempoDate, 'H-1', tipePelanggan);
        setReminderCell(cell, "üö® Reminder H-1", waLinkH1, "#dc2626");
        logs.clientReminderH1Log += `${i + 1}. - ${nama} (H-1, Status: ${status}) | ${waLinkH1}\n\n`;
      } else {
        setReminderCell(cell, "üö® H-1 (No WA)", null, "#dc2626");
        logs.clientReminderH1Log += `${i + 1}. - ${nama} (H-1, Status: ${status}) | [NO WA]\n\n`;
      }
    } else {
      cell.setValue("").setFormula("");
    }
  } else if (selisihHari === 0) {
    // HARI H: Warning Reminder
    if (isEligible) {
      if (nomorWA) {
        var waLinkHariH = generateWhatsAppLink(nama, nomorWA, kitNumber, serialNumber, paket, jatuhTempoDate, 'WARNING', tipePelanggan);
        setReminderCell(cell, "üíÄ Warning Reminder", waLinkHariH, "#7c2d12");
        logs.clientWarningLog += `${i + 1}. - ${nama} (Warning, Status: ${status}) | ${waLinkHariH}\n\n`;
      } else {
        setReminderCell(cell, "üíÄ Warning (No WA)", null, "#7c2d12");
        logs.clientWarningLog += `${i + 1}. - ${nama} (Warning, Status: ${status}) | [NO WA]\n\n`;
      }
    } else {
      cell.setValue("").setFormula("");
    }
  } else {
    // Clear cell untuk hari lain
    cell.setValue("").setFormula("");
  }
}

/**
 * ‚úÖ FIXED: Send consolidated email (now uses logs object)
 */
function sendConsolidatedEmail(logs) {
  var emailBody = `${logs.clientProsesLog}\n${logs.clientReminderH3Log}\n${logs.clientReminderH2Log}\n${logs.clientReminderH1Log}\n${logs.clientWarningLog}\n${logs.clientJatuhTempoLog}\n\nBerikut adalah daftar data yang tidak lengkap:\n\n${logs.errorLog}`;
  
  if (emailBody.trim() !== "") {
    Logger.log("Mengirim email dengan body:\n" + emailBody);
    MailApp.sendEmail({
      to: "baiiput@gmail.com, octobiztech@gmail.com",
      subject: "Client Reminder H-3, H-2, H-1, Warning (Hari H), dan Jatuh Tempo",
      body: emailBody
    });
    Logger.log("Email telah dikirim dengan informasi lengkap H-3, H-2, H-1, dan Warning Hari H.");
  } else {
    Logger.log("emailBody kosong. Tidak ada email yang dikirim.");
  }
}

/**
 * ‚úÖ NEW: Generate WhatsApp link dengan KIT Number, Serial Number, dan Tipe Pelanggan
 */
function generateWhatsAppLink(nama, nomorWA, kitNumber, serialNumber, paket, jatuhTempoDate, type, tipePelanggan) {
  var kitInfo = '';

  // Handle KIT Number dan Serial Number
  if (kitNumber || serialNumber) {
    var kitLines = [];
    var kitArray = kitNumber ? (kitNumber.includes('\n') ? kitNumber.split('\n') : [kitNumber]) : ['Data KIT tidak tersedia'];
    var serialArray = serialNumber ? (serialNumber.includes('\n') ? serialNumber.split('\n') : [serialNumber]) : ['Data Serial tidak tersedia'];
    var paketArray = paket ? (paket.includes('\n') ? paket.split('\n') : [paket]) : ['Data paket tidak tersedia'];

    var maxLength = Math.max(kitArray.length, serialArray.length, paketArray.length);

    for (var j = 0; j < maxLength; j++) {
      var kitItem = kitArray[j] || kitArray[0] || 'N/A';
      var serialItem = serialArray[j] || serialArray[0] || 'N/A';
      var paketItem = paketArray[j] || paketArray[0] || 'N/A';
      kitLines.push(`   ‚úÖ KIT: ${kitItem} | SN: ${serialItem} (${paketItem})`);
    }

    kitInfo = kitLines.join('\n');
  }

  var messages = {
    'H-3': generateH3Message(nama, kitInfo, jatuhTempoDate, tipePelanggan),
    'H-2': generateH2Message(nama, kitInfo, jatuhTempoDate, tipePelanggan),
    'H-1': generateH1Message(nama, kitInfo, jatuhTempoDate, tipePelanggan),
    'WARNING': generateWarningMessage(nama, kitInfo, jatuhTempoDate, tipePelanggan)
  };

  var message = messages[type] || messages['H-3'];
  return `https://web.whatsapp.com/send?phone=${nomorWA}&text=${encodeURIComponent(message)}`;
}

/**
 * ‚úÖ NEW: Set reminder cell with proper formatting
 */
function setReminderCell(cell, text, url, color) {
  if (url) {
    var richText = SpreadsheetApp.newRichTextValue()
      .setText(text)
      .setLinkUrl(url)
      .build();
    cell.setRichTextValue(richText);
  } else {
    cell.setValue(text);
  }
  
  cell.setFontSize(12)
      .setFontWeight("bold")
      .setHorizontalAlignment("center")
      .setVerticalAlignment("middle")
      .setFontColor(color);
}

/**
 * ‚úÖ NEW: Message generators
 */
function generateH3Message(nama, kitInfo, jatuhTempoDate, tipePelanggan) {
  var satuHariSebelumJatuhTempo = new Date(jatuhTempoDate);
  satuHariSebelumJatuhTempo.setDate(satuHariSebelumJatuhTempo.getDate() - 1);
  var namaHariSebelumnya = getNamaHari(satuHariSebelumJatuhTempo);
  var tipePelangganInfo = tipePelanggan ? `üîπ *Tipe Pelanggan:* ${tipePelanggan}\n` : '';

  return `üì° *Halo ${nama}, Pengguna Layanan Internet Starlink* üì°\n\n` +
    `üìå *Informasi Layanan Anda:*\n` +
    `üîπ *Nama:* ${nama}\n` +
    `üîπ *Detail Starlink:*\n${kitInfo}\n` +
    `üîπ *Tanggal Jatuh Tempo:* ${formatTanggalIndonesia(jatuhTempoDate)}\n` +
    tipePelangganInfo +
    `\nüìÖ Kami ingin menginformasikan bahwa layanan Starlink Anda akan jatuh tempo dalam 3 hari pada tanggal tersebut.\n\n` +
    `Untuk memastikan kesinambungan layanan internet Anda, mohon konfirmasi perpanjangan layanan maksimal pada hari *${namaHariSebelumnya}*.\n\n` +
    `Jika memerlukan bantuan atau informasi lebih lanjut, silakan hubungi kami.\n\n` +
    `Terima kasih atas perhatian dan kepercayaan Anda.\n\n` +
    `üöÄ *Octolink.id - Starlink UnOfficial Support* üöÄ`;
}

function generateH2Message(nama, kitInfo, jatuhTempoDate, tipePelanggan) {
  var tipePelangganInfo = tipePelanggan ? `üîπ *Tipe Pelanggan:* ${tipePelanggan}\n` : '';

  return `üì° *Halo ${nama}, Pengguna Layanan Internet Starlink* üì°\n\n` +
    `üìå *Informasi Layanan Anda:*\n` +
    `üîπ *Nama:* ${nama}\n` +
    `üîπ *Detail Starlink:*\n${kitInfo}\n` +
    `üîπ *Tanggal Jatuh Tempo:* ${formatTanggalIndonesia(jatuhTempoDate)}\n` +
    tipePelangganInfo +
    `\n‚ö†Ô∏è Pemberitahuan penting: layanan Starlink Anda akan jatuh tempo dalam 2 hari pada tanggal tersebut.\n\n` +
    `Untuk menghindari gangguan layanan, kami merekomendasikan agar perpanjangan segera dilakukan.\n\n` +
    `‚è∞ Waktu perpanjangan semakin terbatas, mohon segera lakukan konfirmasi.\n\n` +
    `Jika memerlukan bantuan atau informasi lebih lanjut, silakan hubungi kami.\n\n` +
    `Terima kasih atas perhatian dan kepercayaan Anda.\n\n` +
    `üöÄ *Octolink.id - Starlink UnOfficial Support* üöÄ`;
}

function generateH1Message(nama, kitInfo, jatuhTempoDate, tipePelanggan) {
  var tipePelangganInfo = tipePelanggan ? `üîπ *Tipe Pelanggan:* ${tipePelanggan}\n` : '';

  return `üì° *Halo ${nama}, Pengguna Layanan Internet Starlink* üì°\n\n` +
    `üìå *Informasi Layanan Anda:*\n` +
    `üîπ *Nama:* ${nama}\n` +
    `üîπ *Detail Starlink:*\n${kitInfo}\n` +
    `üîπ *Tanggal Jatuh Tempo:* ${formatTanggalIndonesia(jatuhTempoDate)}\n` +
    tipePelangganInfo +
    `\nüö® Peringatan urgent: layanan Starlink Anda akan jatuh tempo BESOK pada tanggal tersebut.\n\n` +
    `Mohon konfirmasi perpanjangan layanan HARI INI untuk menghindari terputusnya koneksi internet.\n\n` +
    `‚è∞ Ini adalah pengingat terakhir sebelum masa aktif berakhir.\n\n` +
    `Jika memerlukan bantuan atau informasi lebih lanjut, silakan hubungi kami segera.\n\n` +
    `Terima kasih atas perhatian dan kepercayaan Anda.\n\n` +
    `üöÄ *Octolink.id - Starlink UnOfficial Support* üöÄ`;
}

function generateWarningMessage(nama, kitInfo, jatuhTempoDate, tipePelanggan) {
  var tipePelangganInfo = tipePelanggan ? `üîπ *Tipe Pelanggan:* ${tipePelanggan}\n` : '';

  return `‚ö†Ô∏è *PENTING: Layanan Internet Starlink Berakhir Hari Ini* ‚ö†Ô∏è\n\n` +
    `üë§ *${nama}*\n` +
    `üìÖ *Masa Aktif Berakhir: HARI INI* (${formatTanggalIndonesia(jatuhTempoDate)})\n` +
    tipePelangganInfo +
    `\nüõ∞Ô∏è *Starlink yang terpengaruh:*\n${kitInfo}\n\n` +
    `‚è∞ *Mohon konfirmasi perpanjangan secepatnya untuk menghindari pemutusan layanan.*\n\n` +
    `Untuk informasi perpanjangan atau bantuan teknis, silakan hubungi kami.\n\n` +
    `üöÄ *Octolink.id - Starlink UnOfficial Support* üöÄ`;
}

/**
 * ‚úÖ NEW: Reactivate filter
 */
function reactivateFilter(sheet) {
  Utilities.sleep(3000);
  var rangeToFilter = sheet.getRange(1, 1, sheet.getLastRow(), COLUMNS.TOMBOL_WHATSAPP + 1); // Y column
  sheet.getFilter() && sheet.getFilter().remove();
  rangeToFilter.createFilter();
  Logger.log("‚úÖ Filter dari kolom A sampai Y diaktifkan kembali.");
}

// ========================================
// üìä 9. REPORT MANAGEMENT FUNCTIONS
// ========================================

/**
 * üîß Get Report Spreadsheet
 */
function getReportSpreadsheet() {
  try {
    var reportSpreadsheet = SpreadsheetApp.openById(REPORT_SPREADSHEET_ID);
    Logger.log('‚úÖ Report spreadsheet connected: ' + reportSpreadsheet.getName());
    return reportSpreadsheet;
  } catch (error) {
    Logger.log('‚ùå Error connecting to report spreadsheet: ' + error.message);
    throw new Error('Tidak dapat mengakses file laporan terpisah. ID: ' + REPORT_SPREADSHEET_ID);
  }
}

/**
 * üîß Get Report Sheet (FIXED: Better formatting for new sheets)
 */
function getReportSheet(month, year, createIfNotExists = false) {
  try {
    var reportSpreadsheet = getReportSpreadsheet();
    var sheetName = month.toString().padStart(2, '0') + '_' + year.toString();
    var sheet = reportSpreadsheet.getSheetByName(sheetName);
    
    if (!sheet && createIfNotExists) {
      Logger.log('Creating new report sheet with CORRECT formatting: ' + sheetName);
      
      sheet = reportSpreadsheet.insertSheet(sheetName);
      
      // Headers yang benar sesuai format konsisten
      var headers = [
        'Nomor',              // A
        'Tanggal Transaksi',  // B  
        'ID Transaksi',       // C
        'Nama Client',        // D
        'KIT Number',         // E - FIXED: Konsisten dengan sheet lain
        'Serial Number',      // F - BARU
        'Paket',              // G - GESER dari F
        'Tipe Pembayaran',    // H - GESER dari G
        'Nominal',            // I - GESER dari H
        'Jumlah Total',       // J - GESER dari I
        'Total Harian'        // K - GESER dari J
      ];
      
      // Set headers
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // FIXED: Apply formatting khusus untuk sheet baru
      formatNewReportSheet(sheet);
      
      Logger.log('‚úÖ New report sheet created with proper formatting: ' + sheetName);
    }
    
    return sheet;
  } catch (error) {
    Logger.log('‚ùå Error getting report sheet: ' + error.message);
    throw error;
  }
}

/**
 * üé® Format New Report Sheet (Khusus untuk sheet baru yang kosong)
 */
function formatNewReportSheet(sheet) {
  try {
    Logger.log('üé® Applying formatting to new report sheet...');
    
    var headers = 11; // A-K columns
    
    // 1. HEADER FORMATTING (Row 1)
    var headerRange = sheet.getRange(1, 1, 1, headers);
    headerRange.setFontWeight('bold')
              .setBackground('#1e3a8a')        // Dark blue
              .setFontColor('white')
              .setHorizontalAlignment('center')
              .setVerticalAlignment('middle')
              .setFontSize(11)
              .setFontFamily('Roboto');
    
    // 2. COLUMN WIDTHS - Set specific widths for each column
    var columnWidths = {
      1: 60,   // A: Nomor
      2: 120,  // B: Tanggal  
      3: 160,  // C: Transaction ID
      4: 140,  // D: Nama Client
      5: 140,  // E: KIT Number
      6: 140,  // F: Serial Number
      7: 100,  // G: Paket
      8: 120,  // H: Tipe Pembayaran
      9: 110,  // I: Nominal
      10: 130, // J: Jumlah Total
      11: 150  // K: Total Harian
    };
    
    for (var col = 1; col <= headers; col++) {
      sheet.setColumnWidth(col, columnWidths[col]);
    }
    
    // 3. HEADER BORDERS
    headerRange.setBorder(
      true, true, true, true, true, true,
      '#1e3a8a',
      SpreadsheetApp.BorderStyle.SOLID
    );
    
    // 4. SET ROW HEIGHT for header
    sheet.setRowHeight(1, 35);
    
    // 5. FREEZE HEADER ROW
    sheet.setFrozenRows(1);
    
    Logger.log('‚úÖ New report sheet formatting completed successfully');
    
  } catch (error) {
    Logger.log('‚ùå Error formatting new report sheet: ' + error.message);
  }
}

/**
 * ‚úÖ NEW: Remove existing filters from report sheet
 */
function removeExistingFiltersFromReportSheet(sheet) {
  try {
    Logger.log('üîÑ Removing existing filters from report sheet...');
    
    if (sheet.getFilter()) {
      sheet.getFilter().remove();
      Logger.log('‚úÖ Existing filter removed from report sheet');
    } else {
      Logger.log('‚ÑπÔ∏è No existing filter found on report sheet');
    }
    
    // Clear any existing filter criteria
    var lastRow = sheet.getLastRow();
    var lastCol = sheet.getLastColumn();
    
    if (lastRow > 0 && lastCol > 0) {
      // Reset any hidden rows
      sheet.showRows(1, lastRow);
      Logger.log('‚úÖ All rows shown in report sheet');
    }
    
  } catch (error) {
    Logger.log('‚ö†Ô∏è Error removing filters: ' + error.message);
  }
}

function applyDateFilterToReportSheet(sheet, filterDate) {
  try {
    // Safeguard: Pastikan hanya apply filter pada sheet yang benar
    var expectedSheetName = (filterDate.getMonth() + 1).toString().padStart(2, '0') + '_' + filterDate.getFullYear();
    var actualSheetName = sheet.getName();
    
    Logger.log('üîÑ Applying filter to sheet: ' + actualSheetName);
    Logger.log('üìÖ Filter date: ' + filterDate.toDateString());
    Logger.log('üìÖ Expected sheet for filter date: ' + expectedSheetName);
    
    // Check if this is the correct sheet for the filter date
    if (actualSheetName !== expectedSheetName) {
      Logger.log('‚ö†Ô∏è SKIP: Filter not applied - sheet is not for the filter date month/year');
      Logger.log('   Current sheet: ' + actualSheetName);
      Logger.log('   Filter date requires: ' + expectedSheetName);
      return; // Exit early - don't apply filter to wrong month/year sheets
    }
    
    var lastRow = sheet.getLastRow();
    var lastCol = sheet.getLastColumn();
    
    if (lastRow <= 1) {
      Logger.log('‚ÑπÔ∏è No data to filter in sheet: ' + actualSheetName);
      return;
    }
    
    // ‚úÖ MAJOR CHANGE: Use filterDate instead of today
    var targetDate = new Date(filterDate);
    targetDate.setHours(0, 0, 0, 0);
    
    var targetDateFormatted = targetDate.getDate().toString().padStart(2, '0') + '/' + 
                             (targetDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             targetDate.getFullYear();
    
    Logger.log('üìÖ Filtering sheet "' + actualSheetName + '" for date: ' + targetDateFormatted);
    
    // Remove any existing filter first on THIS SHEET ONLY
    if (sheet.getFilter()) {
      sheet.getFilter().remove();
      Logger.log('üóëÔ∏è Removed existing filter from sheet: ' + actualSheetName);
    }
    
    // Create filter range for THIS SHEET ONLY
    var filterRange = sheet.getRange(1, 1, lastRow, lastCol);
    var filter = filterRange.createFilter();
    
    // Try Date format first
    try {
      var dateCriteria = SpreadsheetApp.newFilterCriteria()
        .whenDateEqualTo(targetDate)
        .build();
      
      filter.setColumnFilterCriteria(2, dateCriteria);
      Logger.log('‚úÖ Date filter applied successfully to sheet: ' + actualSheetName + ' for date: ' + targetDateFormatted);
      return;
      
    } catch (dateError) {
      Logger.log('‚ö†Ô∏è Date filter failed for sheet: ' + actualSheetName + ', trying text format...');
      
      // Fallback to text format
      try {
        var textCriteria = SpreadsheetApp.newFilterCriteria()
          .whenTextEqualTo(targetDateFormatted)
          .build();
        
        filter.setColumnFilterCriteria(2, textCriteria);
        Logger.log('‚úÖ Text filter applied successfully to sheet: ' + actualSheetName + ' for date: ' + targetDateFormatted);
        return;
        
      } catch (textError) {
        Logger.log('‚ö†Ô∏è Text filter also failed for sheet: ' + actualSheetName + ', keeping basic filter');
      }
    }
    
  } catch (error) {
    Logger.log('‚ùå Filter error for sheet ' + sheet.getName() + ': ' + error.message);
    
    // Final fallback - just create basic filter on THIS SHEET ONLY
    try {
      if (sheet.getFilter()) {
        sheet.getFilter().remove();
      }
      var filterRange = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn());
      filterRange.createFilter();
      Logger.log('‚úÖ Basic filter created as fallback for sheet: ' + sheet.getName());
    } catch (fallbackError) {
      Logger.log('‚ùå Even basic filter failed for sheet ' + sheet.getName() + ': ' + fallbackError.message);
    }
  }
}

/**
 * Check if requestId has already been submitted
 * @param {string} requestId - Unique request identifier
 * @return {boolean} - true if already submitted, false otherwise
 */
function isRequestIdAlreadySubmitted(requestId) {
  try {
    const cacheKey = REQUEST_ID_CACHE_KEY_PREFIX + requestId;
    const cached = SCRIPT_PROPERTIES.getProperty(cacheKey);
    
    if (cached) {
      const cacheData = JSON.parse(cached);
      const now = new Date().getTime();
      
      // Check if cache is still valid (within 5 minutes)
      if (now - cacheData.timestamp < REQUEST_ID_CACHE_DURATION) {
        Logger.log('üö´ Duplicate requestId detected: ' + requestId);
        Logger.log('Original submission time: ' + new Date(cacheData.timestamp).toISOString());
        return true;
      } else {
        // Cache expired, remove it
        SCRIPT_PROPERTIES.deleteProperty(cacheKey);
      }
    }
    
    return false;
  } catch (error) {
    Logger.log('‚ö†Ô∏è Error checking requestId cache: ' + error.message);
    // On error, allow submission (fail-safe approach)
    return false;
  }
}

/**
 * Mark requestId as submitted
 * @param {string} requestId - Unique request identifier
 */
function markRequestIdAsSubmitted(requestId) {
  try {
    const cacheKey = REQUEST_ID_CACHE_KEY_PREFIX + requestId;
    const cacheData = {
      timestamp: new Date().getTime(),
      requestId: requestId
    };
    
    SCRIPT_PROPERTIES.setProperty(cacheKey, JSON.stringify(cacheData));
    Logger.log('‚úÖ RequestId marked as submitted: ' + requestId);
    
    // Note: Apps Script doesn't support setTimeout, so cleanup happens on next check
    
  } catch (error) {
    Logger.log('‚ö†Ô∏è Error marking requestId: ' + error.message);
  }
}

/**
 * Cleanup expired requestId cache entries (call this periodically)
 * Can be run as a time-based trigger (e.g., every hour)
 */
function cleanupExpiredRequestIds() {
  try {
    const allProperties = SCRIPT_PROPERTIES.getProperties();
    const now = new Date().getTime();
    let cleanedCount = 0;
    
    for (var key in allProperties) {
      if (key.startsWith(REQUEST_ID_CACHE_KEY_PREFIX)) {
        try {
          const cacheData = JSON.parse(allProperties[key]);
          
          // If older than cache duration, delete
          if (now - cacheData.timestamp >= REQUEST_ID_CACHE_DURATION) {
            SCRIPT_PROPERTIES.deleteProperty(key);
            cleanedCount++;
          }
        } catch (parseError) {
          // If can't parse, delete it
          SCRIPT_PROPERTIES.deleteProperty(key);
          cleanedCount++;
        }
      }
    }
    
    Logger.log('üßπ Cleaned up ' + cleanedCount + ' expired requestId cache entries');
    return {
      status: 'success',
      cleanedCount: cleanedCount
    };
    
  } catch (error) {
    Logger.log('‚ö†Ô∏è Error in cleanup: ' + error.message);
    return {
      status: 'error',
      message: error.message
    };
  }
}

function submitPaymentDataMultiKit(formData) {
  try {
    Logger.log('=== SUBMIT WITH DUPLICATE PREVENTION START ===');
    Logger.log('Form data received: ' + JSON.stringify(formData));
    
    // üö´ CRITICAL: Check for duplicate requestId FIRST
    if (formData.requestId) {
      Logger.log('üîç Checking requestId: ' + formData.requestId);
      
      if (isRequestIdAlreadySubmitted(formData.requestId)) {
        Logger.log('üö´ DUPLICATE SUBMISSION BLOCKED: ' + formData.requestId);
        return {
          status: 'error',
          message: 'üö´ Duplicate submission detected. This request has already been processed.',
          isDuplicate: true,
          requestId: formData.requestId
        };
      }
      
      // Mark this requestId as being processed
      markRequestIdAsSubmitted(formData.requestId);
    } else {
      Logger.log('‚ö†Ô∏è No requestId provided - duplicate prevention disabled for this request');
    }
    
    if (!formData || !formData.selectedKits || formData.selectedKits.length === 0) {
      Logger.log('Error: No selectedKits found');
      return {
        status: 'error',
        message: 'Tidak ada KIT yang dipilih'
      };
    }
    
    // ‚úÖ IMPORTANT: Extract transaction date from form data
    var tanggal = new Date(formData.tanggal);
    var month = tanggal.getMonth() + 1;
    var year = tanggal.getFullYear();
    
    Logger.log('üìÖ Transaction date from form: ' + tanggal.toDateString());
    Logger.log('üìÖ Will filter for: ' + tanggal.getDate() + '/' + month + '/' + year);
    
    try {
      var reportSpreadsheet = getReportSpreadsheet();
      Logger.log('‚úÖ Connection to separate file successful');
    } catch (connectionError) {
      return {
        status: 'error',
        message: 'Gagal terhubung ke file laporan terpisah: ' + connectionError.message
      };
    }
    
    var sheet = getReportSheet(month, year, true);

    // ‚úÖ NEW: Remove existing filters BEFORE processing
    removeExistingFiltersFromReportSheet(sheet);

    var lastRow = sheet.getLastRow();

    var day = tanggal.getDate().toString().padStart(2, '0');
    var monthStr = month.toString().padStart(2, '0');
    var yearStr = year.toString();
    var formattedDate = `${day}/${monthStr}/${yearStr}`;

    // üÜï NEW LOGIC: Check if should submit as multiple entries (one row per KIT)
    // üîß FIX: Changed > 1 to >= 1 to include single KIT with per-KIT payment type
    if (formData.submitAsMultipleEntries && formData.selectedKits.length >= 1) {
      Logger.log('üîÑ Processing as MULTIPLE SEPARATE ENTRIES (one row per KIT)');
      Logger.log('üìä Total KITs to insert: ' + formData.selectedKits.length);

      var insertedTransactionIDs = [];
      var insertedRows = [];

      // Loop each KIT and insert as separate entry
      for (var kitIndex = 0; kitIndex < formData.selectedKits.length; kitIndex++) {
        var kit = formData.selectedKits[kitIndex];

        // Generate unique transaction ID for each KIT
        var transactionID = generateTransactionID(tanggal, month, year);
        insertedTransactionIDs.push(transactionID);

        Logger.log('Processing KIT ' + (kitIndex + 1) + '/' + formData.selectedKits.length + ': ' + kit.kitNumber);
        Logger.log('  - Transaction ID: ' + transactionID);
        Logger.log('  - Nominal: ' + kit.nominal);
        Logger.log('  - Tipe Pembayaran: ' + (kit.tipePembayaran || '(EMPTY!)'));
        Logger.log('  - Client Name: ' + (kit.clientName || formData.nama));

        // Get current last row (updates after each insert)
        lastRow = sheet.getLastRow();
        var newRowNumber = lastRow;

        // Create row data for this KIT
        var rowData = [
          newRowNumber,               // A: Nomor
          formattedDate,              // B: Tanggal
          transactionID,              // C: ID Transaksi
          kit.clientName || formData.nama,  // D: Nama Client (üîß FIX: Per-KIT client name)
          kit.kitNumber,              // E: Serial Number (KIT)
          kit.serialNumber || '',     // F: Serial Number
          kit.paket,                  // G: Paket
          kit.tipePembayaran || '',   // H: Tipe Pembayaran (üÜï NOW PER-KIT)
          kit.nominal                 // I: Nominal (per-KIT nominal)
        ];

        // Insert this row
        sheet.getRange(lastRow + 1, 1, 1, rowData.length).setValues([rowData]);
        insertedRows.push(rowData);

        Logger.log('‚úÖ Inserted row ' + (kitIndex + 1) + ': ' + JSON.stringify(rowData));
      }

      Logger.log('‚úÖ All ' + formData.selectedKits.length + ' KITs inserted as separate entries');
      Logger.log('üìã Transaction IDs: ' + insertedTransactionIDs.join(', '));

      // Sort and organize after all inserts
      sortAndOrganizeWithNew11ColumnStructure(sheet);

      // Apply filter based on transaction date
      applyDateFilterToReportSheet(sheet, tanggal);

      // üîß FIX: Update client data with transaction IDs - each KIT gets its own transaction ID
      var allUpdateResults = { updated: [], notFound: [] };

      for (var kitIndex = 0; kitIndex < formData.selectedKits.length; kitIndex++) {
        var kit = formData.selectedKits[kitIndex];
        var transactionID = insertedTransactionIDs[kitIndex]; // Match by index

        Logger.log('Updating client data for KIT ' + (kitIndex + 1) + ': ' + kit.kitNumber + ' with Transaction ID: ' + transactionID);

        // Update this specific KIT with its own transaction ID
        var updateResult = updateClientDataWithTransactionID([kit], transactionID);

        // Merge results
        allUpdateResults.updated = allUpdateResults.updated.concat(updateResult.updated);
        allUpdateResults.notFound = allUpdateResults.notFound.concat(updateResult.notFound);
      }

      Logger.log('‚úÖ Client data updates completed: ' + allUpdateResults.updated.length + ' updated, ' + allUpdateResults.notFound.length + ' not found');

      // Send email notification
      try {
        sendEmailNotificationMultiKitWithTransactionID(formData, sheet.getName(), insertedTransactionIDs.join(', '), allUpdateResults);
      } catch (emailError) {
        Logger.log('‚ö†Ô∏è Email notification failed but submission successful: ' + emailError.message);
      }

      return {
        status: 'success',
        message: 'Data berhasil disubmit! ' + formData.selectedKits.length + ' KIT diproses sebagai entry terpisah.',
        transactionIDs: insertedTransactionIDs,
        totalEntries: formData.selectedKits.length,
        requestId: formData.requestId,
        sheetName: sheet.getName(),
        clientUpdates: allUpdateResults,
        timestamp: new Date().toISOString()
      };

    } else {
      // Original logic for single entry (backward compatibility)
      Logger.log('üìù Processing as SINGLE ENTRY (original behavior)');

      var transactionID = generateTransactionID(tanggal, month, year);
      Logger.log('Generated Transaction ID: ' + transactionID);

      var newRowNumber = lastRow;

      // ‚úÖ CRITICAL: Prepare serialNumbers untuk multiple kit
      var serialNumbers = '';
      if (formData.isMultipleKit && formData.kitCount > 1) {
        var serialNumArray = formData.selectedKits.map(function(kit) {
          return kit.serialNumber || '';
        });
        serialNumbers = serialNumArray.join('\n');
        Logger.log('Prepared serial numbers for multiple kit: ' + serialNumbers);
      } else if (formData.selectedKits.length === 1) {
        serialNumbers = formData.selectedKits[0].serialNumber || '';
        Logger.log('Single kit serial number: ' + serialNumbers);
      }

      var rowData;
      if (formData.isMultipleKit && formData.kitCount > 1) {
        // ‚úÖ NEW: Struktur 11 kolom dengan Serial Number terpisah
        rowData = [
          newRowNumber,         // A: Nomor
          formattedDate,        // B: Tanggal
          transactionID,        // C: ID Transaksi
          formData.nama,        // D: Nama Client
          formData.kitNumbers,  // E: Serial Number (KIT) ‚Üê dari KIT Number client
          serialNumbers,        // F: Serial Number ‚Üê BARU dari Serial Number client
          formData.kitPackages, // G: Paket ‚Üê GESER dari F
          formData.selectedKits[0].tipePembayaran || formData.tipe || '',  // H: Tipe Pembayaran (üîß FIX: Use per-KIT)
          formData.nominal      // I: Nominal ‚Üê GESER dari H
          // J: Jumlah Total akan dihitung running total ‚Üê GESER dari I
          // K: Total Harian akan di-merge ‚Üê GESER dari J
        ];
      } else {
        var kit = formData.selectedKits[0];
        // ‚úÖ NEW: Struktur 11 kolom untuk single kit
        rowData = [
          newRowNumber,         // A: Nomor
          formattedDate,        // B: Tanggal
          transactionID,        // C: ID Transaksi
          formData.nama,        // D: Nama Client
          kit.kitNumber,        // E: Serial Number (KIT) ‚Üê dari KIT Number client
          kit.serialNumber || '', // F: Serial Number ‚Üê BARU dari Serial Number client
          kit.paket,           // G: Paket ‚Üê GESER dari F
          kit.tipePembayaran || formData.tipe || '',  // H: Tipe Pembayaran (üîß FIX: Use per-KIT first)
          kit.nominal || formData.nominal // I: Nominal ‚Üê GESER dari H
          // J: Jumlah Total akan dihitung running total ‚Üê GESER dari I
          // K: Total Harian akan di-merge ‚Üê GESER dari J
        ];
      }

      // Insert data (sampai kolom I saja, J dan K akan dihitung)
      sheet.getRange(lastRow + 1, 1, 1, rowData.length).setValues([rowData]);
      Logger.log('‚úÖ Data inserted with NEW 11-column structure');
      Logger.log('Row data: ' + JSON.stringify(rowData));
    }
    
    // ‚úÖ CRITICAL: Panggil fungsi dengan nama BARU
    sortAndOrganizeWithNew11ColumnStructure(sheet);
    
    // ‚úÖ MAJOR CHANGE: Apply filter based on transaction date, not today
    applyDateFilterToReportSheet(sheet, tanggal);
    
    var updateResult = updateClientDataWithTransactionID(formData.selectedKits, transactionID);
    
    try {
      sendEmailNotificationMultiKitWithTransactionID(formData, sheet.getName(), transactionID, updateResult);
    } catch (emailError) {
      Logger.log('‚ö†Ô∏è Email notification failed but submission successful: ' + emailError.message);
    }
    
    // ‚úÖ SUCCESS: Return dengan requestId untuk tracking
    return {
      status: 'success',
      message: 'Data berhasil disubmit!',
      transactionID: transactionID,
      requestId: formData.requestId,
      sheetName: sheet.getName(),
      clientUpdates: updateResult,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log('‚ùå Error in submitPaymentDataMultiKit: ' + error.message);
    Logger.log('Error stack: ' + error.stack);
    
    // On error, try to cleanup the requestId cache so user can retry
    if (formData && formData.requestId) {
      try {
        const cacheKey = REQUEST_ID_CACHE_KEY_PREFIX + formData.requestId;
        SCRIPT_PROPERTIES.deleteProperty(cacheKey);
        Logger.log('üßπ Cleaned up failed requestId from cache: ' + formData.requestId);
      } catch (cleanupError) {
        Logger.log('‚ö†Ô∏è Error cleaning up requestId cache: ' + cleanupError.message);
      }
    }
    
    return {
      status: 'error',
      message: 'Error: ' + error.message,
      requestId: formData?.requestId,
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * üîß Check Duplicate dengan kolom mapping baru
 */
function checkDuplicateInReportMultiKit(kitNumbers, month, year) {
  try {
    if (!month || !year) {
      var currentDate = new Date();
      month = currentDate.getMonth() + 1;
      year = currentDate.getFullYear();
    }
    
    var sheet = getReportSheet(month, year, false);
    
    if (!sheet) {
      return {
        status: 'no_duplicate',
        hasDuplicate: false,
        duplicateData: [],
        duplicateKits: []
      };
    }
    
    var data = sheet.getDataRange().getValues();
    var duplicates = [];
    var duplicateKits = [];
    
    // ‚úÖ UNCHANGED: Masih cek duplicate di kolom E (Serial Number KIT)
    for (var i = 1; i < data.length; i++) {
      var reportKitCell = data[i][4]; // Kolom E: Serial Number (KIT) ‚Üê masih sama
      
      if (reportKitCell) {
        var reportKit = reportKitCell.toString().trim().toUpperCase();
        var reportKitArray = reportKit.includes('\n') ? reportKit.split('\n') : [reportKit];
        
        for (var j = 0; j < kitNumbers.length; j++) {
          var searchKit = kitNumbers[j].toString().trim().toUpperCase();
          
          for (var k = 0; k < reportKitArray.length; k++) {
            if (reportKitArray[k].trim() === searchKit) {
              
              var tanggalRaw = data[i][1] || '';
              var tanggalFormatted = '';
              
              if (tanggalRaw instanceof Date) {
                var day = tanggalRaw.getDate().toString().padStart(2, '0');
                var month = (tanggalRaw.getMonth() + 1).toString().padStart(2, '0');
                var year = tanggalRaw.getFullYear();
                tanggalFormatted = `${day}/${month}/${year}`;
              } else if (tanggalRaw) {
                var tempDate = new Date(tanggalRaw);
                if (!isNaN(tempDate.getTime())) {
                  var day = tempDate.getDate().toString().padStart(2, '0');
                  var month = (tempDate.getMonth() + 1).toString().padStart(2, '0');
                  var year = tempDate.getFullYear();
                  tanggalFormatted = `${day}/${month}/${year}`;
                } else {
                  tanggalFormatted = tanggalRaw.toString();
                }
              }
              
              // ‚úÖ MINOR UPDATE: Struktur data dengan kolom baru
              duplicates.push({
                rowNumber: i + 1,
                transactionID: data[i][2] || 'No ID',        // C: Transaction ID
                namaClient: data[i][3] || 'No Name',         // D: Nama Client
                tanggal: tanggalFormatted,                   
                kitNumber: data[i][4] || '',                 // E: Serial Number (KIT) ‚Üê masih sama
                serialNumber: data[i][5] || '',              // F: Serial Number ‚Üê BARU
                paket: data[i][6] || '',                     // G: Paket ‚Üê GESER dari F
                tipe: data[i][7] || '',                      // H: Tipe Pembayaran ‚Üê GESER dari G
                nominal: data[i][8] || ''                    // I: Nominal ‚Üê GESER dari H
              });
              duplicateKits.push(kitNumbers[j]);
              break;
            }
          }
        }
      }
    }
    
    return {
      status: duplicates.length > 0 ? 'duplicate_found' : 'no_duplicate',
      hasDuplicate: duplicates.length > 0,
      duplicateData: duplicates,
      duplicateKits: duplicateKits,
      checkedSheet: sheet.getName(),
      reportStructure: 'Updated to 11 columns (A-K)'
    };
    
  } catch (error) {
    return {
      status: 'error',
      hasDuplicate: false,
      duplicateData: [],
      duplicateKits: [],
      error: error.message
    };
  }
}

// ========================================
// üë• 10. CLIENT MANAGEMENT FUNCTIONS
// ========================================

/**
 * üîÑ UPDATED: Validate KIT dengan kolom mapping baru + Serial Number validation
 */
function validateKitForFormMultiKit(kitNumber) {
  try {
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];

    Logger.log('üîç Validating input: ' + kitNumber);
    Logger.log('   - Searching in both KIT Number and Serial Number columns');

    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (!sheet) continue;

      var data = sheet.getDataRange().getValues();

      for (var i = 1; i < data.length; i++) {
        var kitCell = data[i][COLUMNS.KIT_NUMBER]; // I: KIT Number ‚úÖ NEW
        var serialCell = data[i][COLUMNS.SERIAL_NUMBER] || ''; // J: Serial Number ‚úÖ NEW

        // üîß FIX: Search in KIT Number column
        if (kitCell) {
          var kitString = kitCell.toString().trim();
          var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];

          for (var j = 0; j < kitArray.length; j++) {
            if (kitArray[j].trim().toUpperCase() === kitNumber.toUpperCase()) {
              Logger.log('‚úÖ Found match in KIT Number column');
              return buildKitValidationResult(data, i, sheetName, kitNumber, 'KIT Number');
            }
          }
        }

        // üîß FIX: Search in Serial Number column (ALWAYS, not just if starts with UT)
        if (serialCell) {
          var serialString = serialCell.toString().trim();
          var serialArray = serialString.includes('\n') ? serialString.split('\n') : [serialString];

          for (var j = 0; j < serialArray.length; j++) {
            if (serialArray[j].trim().toUpperCase() === kitNumber.toUpperCase()) {
              Logger.log('‚úÖ Found match in Serial Number column');
              return buildKitValidationResult(data, i, sheetName, kitNumber, 'Serial Number');
            }
          }
        }
      }
    }

    return {
      status: 'not_found',
      clientStatus: null,
      isActive: false,
      data: null,
      warning: "‚ùå KIT/Serial Number tidak ditemukan dalam database!"
    };

  } catch (error) {
    return {
      status: 'error',
      clientStatus: null,
      isActive: false,
      data: null,
      warning: "‚ùå Error dalam validasi: " + error.message
    };
  }
}

/**
 * üÜï Helper function to build validation result
 */
function buildKitValidationResult(data, rowIndex, sheetName, searchValue, foundIn) {
  var nama = data[rowIndex][COLUMNS.NAMA] || '';
  var paketCell = data[rowIndex][COLUMNS.PAKET] || ''; // P: Paket
  var kitCell = data[rowIndex][COLUMNS.KIT_NUMBER] || ''; // I: KIT Number
  var serialCell = data[rowIndex][COLUMNS.SERIAL_NUMBER] || ''; // J: Serial Number

  Logger.log('üîç DEBUG - Data yang diambil (found by ' + foundIn + '):');
  Logger.log('   - Nama: ' + nama);
  Logger.log('   - KIT Cell (col I): ' + kitCell);
  Logger.log('   - Serial Cell (col J): ' + serialCell);
  Logger.log('   - Paket Cell (col P): ' + paketCell);

  var kitString = kitCell.toString().trim();
  var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];

  var paketString = paketCell.toString().trim();
  var paketArray = paketString.includes('\n') ? paketString.split('\n') : [paketString];

  var serialString = serialCell.toString().trim();
  var serialArray = serialString.includes('\n') ? serialString.split('\n') : [serialString];

  var allKits = [];

  for (var k = 0; k < kitArray.length; k++) {
    var kit = kitArray[k].trim();
    var paket = paketArray[k] || paketArray[0] || '';
    var serial = serialArray[k] || serialArray[0] || '';

    if (kit) {
      var isMatched = false;

      // Check if this kit matches the search value (by KIT or Serial)
      if (foundIn === 'KIT Number') {
        isMatched = kit.toUpperCase() === searchValue.toUpperCase();
      } else if (foundIn === 'Serial Number') {
        isMatched = serial.trim().toUpperCase() === searchValue.toUpperCase();
      }

      allKits.push({
        kitNumber: kit,
        serialNumber: serial.trim(),
        paket: paket.trim(),
        isSelected: isMatched
      });

      Logger.log(`   - KIT ${k + 1}: ${kit} | SN: ${serial.trim()} | Paket: ${paket.trim()} | Matched: ${isMatched}`);
    }
  }

  return {
    status: 'found',
    clientStatus: sheetName,
    isActive: sheetName === "Client Aktif",
    foundBy: foundIn, // NEW: indicate what field matched
    data: {
      nama: nama.toString().trim(),
      rowNumber: rowIndex + 1,
      sheetName: sheetName,
      allKits: allKits,
      totalKits: allKits.length
    },
    warning: sheetName !== "Client Aktif" ?
      "‚ö†Ô∏è PERHATIAN: Client tidak berada di 'Client Aktif'. Segera update data!" : null
  };
}

/**
 * üîÑ UPDATED: Get All Client Names
 */
function getAllClientNames() {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Client Aktif");
    if (!sheet) {
      return {
        status: 'error',
        message: 'Sheet "Client Aktif" tidak ditemukan'
      };
    }

    var data = sheet.getDataRange().getValues();
    var clientNames = [];

    for (var i = 1; i < data.length; i++) {
      var nama = data[i][COLUMNS.NAMA]; // A: Nama
      if (nama && nama.toString().trim()) {
        clientNames.push(nama.toString().trim());
      }
    }

    var uniqueNames = [];
    var seen = {};
    for (var k = 0; k < clientNames.length; k++) {
      if (!seen[clientNames[k]]) {
        seen[clientNames[k]] = true;
        uniqueNames.push(clientNames[k]);
      }
    }
    uniqueNames.sort();

    return {
      status: 'success',
      data: uniqueNames,
      total: uniqueNames.length
    };

  } catch (error) {
    return {
      status: 'error',
      message: 'Error mengambil data client: ' + error.message
    };
  }
}

/**
 * üîÑ FIXED: Get All Clients By Status dengan field mapping yang benar
 */
function getAllClientsByStatus() {
  try {
    console.log('=== FIXED getAllClientsByStatus START ===');
    
    var allData = {
      proses: [],
      warningReminder: [],
      reminderH1: [],
      reminderH2: [],
      reminderH3: [],
      jatuhTempo: [],
      segera: [],
      observasi: []
    };
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Client Aktif");
    if (!sheet) {
      return {
        status: 'error',
        message: 'Sheet "Client Aktif" tidak ditemukan'
      };
    }

    var data = sheet.getDataRange().getValues();
    console.log(`Processing ${data.length - 1} rows...`);

    for (var i = 1; i < data.length; i++) {
      var nama = data[i][COLUMNS.NAMA] || '';
      var loginGmail = data[i][COLUMNS.LOGIN_GMAIL] || '';
      var loginStarlink = data[i][COLUMNS.LOGIN_STARLINK] || '';
      var emailClient = data[i][COLUMNS.EMAIL_CLIENT] || '';
      var nomorWA = data[i][COLUMNS.NOMOR_CS] || '';
      
      // ‚úÖ FIXED: Proper extraction dengan debug logging
      var kitNumberRaw = data[i][COLUMNS.KIT_NUMBER]; // Column I (index 8)
      var serialNumberRaw = data[i][COLUMNS.SERIAL_NUMBER]; // Column J (index 9)
      var kodeRaw = data[i][COLUMNS.KODE]; // Column L (index 11)
      var paymentRaw = data[i][COLUMNS.PAYMENT]; // Column M (index 12)
      var tipePelangganRaw = data[i][COLUMNS.TIPE_PELANGGAN]; // Column S (index 18)

      // ‚úÖ FIXED: Safe conversion to strings
      var kitNumber = '';
      var serialNumber = '';
      var kode = '';
      var payment = '';
      var tipePelanggan = '';

      if (kitNumberRaw !== null && kitNumberRaw !== undefined) {
        kitNumber = kitNumberRaw.toString().trim();
      }

      if (serialNumberRaw !== null && serialNumberRaw !== undefined) {
        serialNumber = serialNumberRaw.toString().trim();
      }

      if (kodeRaw !== null && kodeRaw !== undefined) {
        kode = kodeRaw.toString().trim();
      }

      if (paymentRaw !== null && paymentRaw !== undefined) {
        payment = paymentRaw.toString().trim();
      }

      if (tipePelangganRaw !== null && tipePelangganRaw !== undefined) {
        tipePelanggan = tipePelangganRaw.toString().trim();
      }

      var jatuhTempo = data[i][COLUMNS.JATUH_TEMPO] || '';
      var transactionID = data[i][COLUMNS.TRANSACTION_ID] || '';
      var status = data[i][COLUMNS.STATUS] || '';
      var paket = data[i][COLUMNS.PAKET] || '';
      
      // Status indicators
      var jatuhTempoLabel = data[i][COLUMNS.LABEL_JATUH_TEMPO] || '';
      var prosesLabel = data[i][COLUMNS.LABEL_PROSES] || '';
      var segaraLabel = data[i][COLUMNS.LABEL_SEGERA] || '';
      var observasiLabel = data[i][COLUMNS.LABEL_OBSERVASI] || '';
      
      if (!nama.toString().trim()) continue;
      
      var jatuhTempoFormatted = '';
      if (jatuhTempo instanceof Date) {
        jatuhTempoFormatted = formatTanggalIndonesia(jatuhTempo);
      } else if (jatuhTempo) {
        var tempDate = new Date(jatuhTempo);
        if (!isNaN(tempDate.getTime())) {
          jatuhTempoFormatted = formatTanggalIndonesia(tempDate);
        }
      }
      
      // ‚úÖ FIXED: Pastikan semua field dikirim dengan benar
      var clientData = {
        nama: nama.toString(),
        loginGmail: loginGmail.toString(),
        loginStarlink: loginStarlink.toString(),
        emailClient: emailClient.toString(),
        nomorWA: nomorWA.toString(),
        kitNumber: kitNumber, // ‚úÖ FIXED: Kirim sebagai string, bukan undefined
        serialNumber: serialNumber, // ‚úÖ FIXED: Kirim sebagai string, bukan undefined
        jatuhTempo: jatuhTempoFormatted,
        paket: paket.toString(),
        kode: kode, // ‚úÖ FIXED: Kirim sebagai string, bukan undefined
        payment: payment, // ‚úÖ FIXED: Kirim sebagai string, bukan undefined
        transactionID: transactionID.toString(),
        status: status.toString(),
        tipePelanggan: tipePelanggan, // ‚úÖ NEW: Tipe Pelanggan dari kolom S
        statusClient: "Client Aktif",
        rowNumber: i + 1
      };
      
      // Kategorikan berdasarkan label
      if (prosesLabel.toString().toUpperCase() === 'PROSES') {
        allData.proses.push(clientData);
      }
      
      if (jatuhTempoLabel.toString().toUpperCase() === 'JATUH TEMPO') {
        allData.jatuhTempo.push(clientData);
      }
      
      if (segaraLabel.toString().toUpperCase() === 'SEGERA') {
        allData.segera.push(clientData);
      }
      
      if (observasiLabel.toString().toUpperCase() === 'OBSERVASI') {
        allData.observasi.push(clientData);
      }
      
      // ‚úÖ Cek reminder dari kolom Y
      try {
        var reminderCell = sheet.getRange(i + 1, COLUMNS.TOMBOL_WHATSAPP + 1);
        var reminderRichText = reminderCell.getRichTextValue();
        
        if (reminderRichText) {
          var reminderText = reminderRichText.getText();
          var reminderUrl = reminderRichText.getLinkUrl();
          
          if (reminderText && reminderUrl) {
            clientData.waLink = reminderUrl;
            
            if (reminderText.includes('üíÄ Warning Reminder')) {
              allData.warningReminder.push(clientData);
            } else if (reminderText.includes('üö® Reminder H-1')) {
              allData.reminderH1.push(clientData);
            } else if (reminderText.includes('‚ö†Ô∏è Reminder H-2')) {
              allData.reminderH2.push(clientData);
            } else if (reminderText.includes('üìÖ Reminder H-3')) {
              allData.reminderH3.push(clientData);
            }
          }
        }
        
      } catch (reminderError) {
        console.log(`‚ùå Error reading reminder cell for row ${i+1}: ${reminderError.message}`);
      }
    }
    
    return {
      status: 'success',
      data: allData
    };
    
  } catch (error) {
    console.log(`‚ùå Error in FIXED getAllClientsByStatus: ${error.message}`);
    console.log(`Stack: ${error.stack}`);
    return {
      status: 'error',
      message: 'Error mengambil data status: ' + error.message
    };
  }
}

// ========================================
// ‚úÖ 11. FORM VALIDATION FUNCTIONS
// ========================================

/**
 * üîÑ UPDATED: Handle Form Validation Multi Kit dengan kolom mapping baru
 */
function handleFormValidationMultiKit(kitNumber, selectedMonth, selectedYear) {
  var validation = validateKitForFormMultiKit(kitNumber);
  
  var duplicate = { status: 'no_duplicate', hasDuplicate: false, duplicateData: [], duplicateKits: [] };
  
  if (validation.status === 'found' && validation.data && validation.data.allKits) {
    var allKitNumbers = validation.data.allKits.map(function(kit) { 
      return kit.kitNumber; 
    });
    
    var month = selectedMonth;
    var year = selectedYear;
    
    if (!month || !year) {
      var currentDate = new Date();
      month = currentDate.getMonth() + 1;
      year = currentDate.getFullYear();
      Logger.log('‚ö†Ô∏è No month/year parameter, using current: ' + month + '/' + year);
    } else {
      Logger.log('‚úÖ Using selected month/year: ' + month + '/' + year);
    }
    
    duplicate = checkDuplicateInReportMultiKit(allKitNumbers, month, year);
  }
  
  return {
    validation: validation,
    duplicate: duplicate,
    selectedMonth: month, 
    selectedYear: year,   
    timestamp: new Date().toISOString(),
    targetFile: REPORT_SPREADSHEET_NAME
  };
}

/**
 * üîÑ UPDATED: Validate Client By Name dengan kolom mapping baru
 */
function validateClientByName(clientName, selectedMonth, selectedYear) {
  try {
    Logger.log('=== validateClientByName START (UPDATED MAPPING) ===');
    Logger.log('Client name: ' + clientName);
    
    const sheetNames = ["Client Aktif", "Client Non Aktif", "Client Lepas"];
    
    for (let sheetName of sheetNames) {
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      if (!sheet) continue;
      
      var data = sheet.getDataRange().getValues();
      
      for (var i = 1; i < data.length; i++) {
        var namaCell = data[i][COLUMNS.NAMA]; // A: Nama
        
        if (namaCell && namaCell.toString().trim().toLowerCase() === clientName.toLowerCase()) {
          Logger.log('‚úÖ Client found: ' + namaCell);
          
          var nama = data[i][COLUMNS.NAMA] || '';
          var kitCell = data[i][COLUMNS.KIT_NUMBER] || ''; // I: KIT Number ‚úÖ NEW
          var serialCell = data[i][COLUMNS.SERIAL_NUMBER] || ''; // J: Serial Number ‚úÖ NEW
          var paketCell = data[i][COLUMNS.PAKET] || ''; // P: Paket ‚úÖ MOVED
          
          var kitString = kitCell.toString().trim();
          var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];
          
          var serialString = serialCell.toString().trim();
          var serialArray = serialString.includes('\n') ? serialString.split('\n') : [serialString];
          
          var paketString = paketCell.toString().trim();
          var paketArray = paketString.includes('\n') ? paketString.split('\n') : [paketString];
          
          var allKits = [];
          for (var k = 0; k < kitArray.length; k++) {
            var kit = kitArray[k].trim();
            var serial = serialArray[k] || serialArray[0] || '';
            var paket = paketArray[k] || paketArray[0] || '';
            
            if (kit) {
              allKits.push({
                kitNumber: kit,
                serialNumber: serial.trim(), // ‚úÖ NEW
                paket: paket.trim(),
                isSelected: false
              });
            }
          }
          
          Logger.log('Found ' + allKits.length + ' KITs for client');
          
          var duplicate = { 
            status: 'no_duplicate', 
            hasDuplicate: false, 
            duplicateData: [], 
            duplicateKits: [] 
          };
          
          if (allKits.length > 0) {
            var allKitNumbers = allKits.map(function(kit) { 
              return kit.kitNumber; 
            });
            
            var month = selectedMonth;
            var year = selectedYear;
            
            if (!month || !year || isNaN(month) || isNaN(year)) {
              var currentDate = new Date();
              month = currentDate.getMonth() + 1;
              year = currentDate.getFullYear();
              Logger.log('‚ö†Ô∏è Invalid month/year, using current: ' + month + '/' + year);
            } else {
              Logger.log('‚úÖ Using provided month/year: ' + month + '/' + year);
            }
            
            duplicate = checkDuplicateInReportMultiKit(allKitNumbers, month, year);
          }
          
          var result = {
            validation: {
              status: 'found',
              data: {
                nama: nama.toString().trim(),
                allKits: allKits,
                totalKits: allKits.length,
                rowNumber: i + 1,
                sheetName: sheetName
              }
            },
            duplicate: duplicate,
            selectedMonth: month,
            selectedYear: year,
            timestamp: new Date().toISOString(),
            targetFile: REPORT_SPREADSHEET_NAME,
            warning: sheetName !== "Client Aktif" ? 
              "‚ö†Ô∏è PERHATIAN: Client tidak berada di 'Client Aktif'." : null
          };
          
          return result;
        }
      }
    }
    
    Logger.log('‚ùå Client not found: ' + clientName);
    return {
      validation: {
        status: 'not_found',
        data: null
      },
      duplicate: { 
        status: 'no_duplicate', 
        hasDuplicate: false, 
        duplicateData: [], 
        duplicateKits: [] 
      },
      selectedMonth: selectedMonth,
      selectedYear: selectedYear,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    Logger.log('‚ùå Error in validateClientByName: ' + error.message);
    
    return {
      validation: {
        status: 'error',
        data: null,
        warning: "‚ùå Error dalam validasi: " + error.message
      },
      duplicate: { 
        status: 'no_duplicate', 
        hasDuplicate: false, 
        duplicateData: [], 
        duplicateKits: [] 
      },
      selectedMonth: selectedMonth,
      selectedYear: selectedYear,
      timestamp: new Date().toISOString()
    };
  }
}

/**
 * üîß Check Duplicates in Month
 */
function checkDuplicatesInMonth(month, year) {
  try {
    Logger.log(`Checking duplicates for ${month}/${year} with NEW 11-column structure...`);
    
    var sheet = getReportSheet(month, year, false);
    
    if (!sheet) {
      return {
        status: 'success',
        hasDuplicates: false,
        message: 'Aman, Tidak ada duplikasi',
        details: `Sheet ${month.toString().padStart(2, '0')}_${year} tidak ditemukan atau kosong.`
      };
    }
    
    var data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return {
        status: 'success',
        hasDuplicates: false,
        message: 'Aman, Tidak ada duplikasi',
        details: `Sheet ${sheet.getName()} kosong atau hanya ada header.`
      };
    }
    
    var kitCounts = {};
    var kitDetails = {};
    
    for (var i = 1; i < data.length; i++) {
      var reportKitCell = data[i][4]; // ‚úÖ UNCHANGED: Kolom E: Serial Number (KIT) masih sama
      
      if (reportKitCell) {
        var kitString = reportKitCell.toString().trim();
        var kitArray = kitString.includes('\n') ? kitString.split('\n') : [kitString];
        
        for (var j = 0; j < kitArray.length; j++) {
          var kit = kitArray[j].trim().toUpperCase();
          
          if (kit) {
            kitCounts[kit] = (kitCounts[kit] || 0) + 1;
            
            if (!kitDetails[kit]) {
              kitDetails[kit] = [];
            }
            
            var tanggalRaw = data[i][1] || '';
            var tanggalFormatted = '';
            
            if (tanggalRaw instanceof Date) {
              var day = tanggalRaw.getDate().toString().padStart(2, '0');
              var monthNum = (tanggalRaw.getMonth() + 1).toString().padStart(2, '0');
              var yearNum = tanggalRaw.getFullYear();
              tanggalFormatted = `${day}/${monthNum}/${yearNum}`;
            } else if (tanggalRaw) {
              var tempDate = new Date(tanggalRaw);
              if (!isNaN(tempDate.getTime())) {
                var day = tempDate.getDate().toString().padStart(2, '0');
                var monthNum = (tempDate.getMonth() + 1).toString().padStart(2, '0');
                var yearNum = tempDate.getFullYear();
                tanggalFormatted = `${day}/${monthNum}/${yearNum}`;
              } else {
                tanggalFormatted = tanggalRaw.toString();
              }
            }
            
            // ‚úÖ MINOR UPDATE: Struktur data dengan kolom baru
            kitDetails[kit].push({
              rowNumber: i + 1,
              transactionID: data[i][2] || 'No ID',        // C: Transaction ID
              namaClient: data[i][3] || 'No Name',         // D: Nama Client  
              tanggal: tanggalFormatted,                   
              kitNumber: kit,                              // E: Serial Number (KIT) ‚Üê masih sama
              serialNumber: data[i][5] || '',              // F: Serial Number ‚Üê BARU
              paket: data[i][6] || '',                     // G: Paket ‚Üê GESER dari F
              tipe: data[i][7] || '',                      // H: Tipe Pembayaran ‚Üê GESER dari G
              nominal: data[i][8] || ''                    // I: Nominal ‚Üê GESER dari H
            });
          }
        }
      }
    }
    
    var duplicates = [];
    
    for (var kit in kitCounts) {
      if (kitCounts[kit] > 1) {
        duplicates.push({
          kitNumber: kit,
          count: kitCounts[kit],
          occurrences: kitDetails[kit]
        });
      }
    }
    
    if (duplicates.length === 0) {
      return {
        status: 'success',
        hasDuplicates: false,
        message: 'Aman, Tidak ada duplikasi',
        sheetName: sheet.getName(),
        totalRows: data.length - 1,
        checkedKits: Object.keys(kitCounts).length,
        reportStructure: 'Updated to 11 columns (A-K)'
      };
    }
    
    return {
      status: 'success',
      hasDuplicates: true,
      message: `Ditemukan ${duplicates.length} KIT yang duplikasi`,
      sheetName: sheet.getName(),
      totalRows: data.length - 1,
      checkedKits: Object.keys(kitCounts).length,
      duplicates: duplicates,
      reportStructure: 'Updated to 11 columns (A-K)'
    };
    
  } catch (error) {
    Logger.log('Error in checkDuplicatesInMonth: ' + error.message);
    return {
      status: 'error',
      hasDuplicates: false,
      message: 'Error saat mengecek duplikasi: ' + error.message
    };
  }
}

/**
 * üîß Check Duplicates by Kit Numbers
 */
function checkDuplicatesByKitNumbers(kitNumbers, month, year) {
  try {
    Logger.log('Checking duplicates by KIT numbers:', kitNumbers);
    
    if (typeof kitNumbers === 'string') {
      kitNumbers = kitNumbers.split(',').map(kit => kit.trim());
    }
    
    if (!Array.isArray(kitNumbers) || kitNumbers.length === 0) {
      return {
        status: 'error',
        message: 'KIT numbers tidak valid',
        hasDuplicate: false,
        duplicateData: [],
        duplicateKits: []
      };
    }
    
    return checkDuplicateInReportMultiKit(kitNumbers, month, year);
    
  } catch (error) {
    Logger.log('Error in checkDuplicatesByKitNumbers: ' + error.message);
    return {
      status: 'error',
      message: 'Error checking duplicates: ' + error.message,
      hasDuplicate: false,
      duplicateData: [],
      duplicateKits: []
    };
  }
}

/**
 * Setup time-based trigger to cleanup expired requestId cache
 * Run this once manually to setup the trigger
 */
function setupCleanupTrigger() {
  // Delete existing triggers first
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'cleanupExpiredRequestIds') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // Create new trigger - runs every hour
  ScriptApp.newTrigger('cleanupExpiredRequestIds')
    .timeBased()
    .everyHours(1)
    .create();
  
  Logger.log('‚úÖ Cleanup trigger created - will run every hour');
}